# Mibu å®˜ç¶²åŠŸèƒ½è¨­è¨ˆè—åœ–
> **ç‰ˆæœ¬**: 1.0 | **å»ºç«‹æ—¥æœŸ**: 2026-01-05 | **ç‹€æ…‹**: å¾…å¯©æ ¸

---

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

### ç¾æœ‰æ¶æ§‹
| ç³»çµ± | æŠ€è¡“æ£§ | ä½ç½® | ç¾æ³ |
|------|--------|------|------|
| **å¾Œç«¯** | Node.js + Express + Drizzle ORM + PostgreSQL | æœ¬å°ˆæ¡ˆ (Replit) | ä¸»è¦é–‹ç™¼ä¸­ |
| **App å‰ç«¯** | Expo + React Native + NativeWind | å¦ä¸€ Replit å°ˆæ¡ˆ | å·²é–‹ç™¼ |
| **å®˜æ–¹ç¶²ç«™** | Replitï¼ˆå¾…ç¢ºèªæ¡†æ¶ï¼‰ | å¦ä¸€ Replit å°ˆæ¡ˆ | **å·²å»ºç«‹**ï¼Œç›®å‰åƒ…æœ‰éš±ç§æ¬Šæ”¿ç­–ã€ä½¿ç”¨æ¢æ¬¾ |

### åŠŸèƒ½ç›®æ¨™
1. **ç¨‹å¼åŒ– SEO** - è®“ Google çˆ¬èŸ²æœå°‹ã€ŒæŸåœ° æ™¯é»/ç¾é£Ÿ/è¡Œç¨‹ã€æ™‚ï¼Œèƒ½æ‰¾åˆ° Mibu å®˜ç¶²
2. **å•†å®¶è¨‚é–±åˆ¶** - å•†å®¶åœ¨å®˜ç¶²è³¼è²·è¨‚é–±ï¼Œæ¬Šé™å³æ™‚åŒæ­¥è‡³ App

---

## ğŸ¯ åŠŸèƒ½ä¸€ï¼šç¨‹å¼åŒ– SEO

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

**ç›´æ¥æ²¿ç”¨ç¾æœ‰ `gacha_ai_logs.aiReason`**ï¼ˆAI æ’åºç†ç”±ï¼‰ï¼Œè½‰æ›ç‚º SEO å‹å–„çš„è¡Œç¨‹ä»‹ç´¹é é¢ã€‚

- **ä¸éœ€é‡æ–°ç”Ÿæˆé•·æ–‡ç« **ï¼Œç¾æœ‰ AI ç†ç”±å·²ç¶“è¶³å¤ 
- **èšåˆé  + å­é çµæ§‹**ï¼Œè®“ Google çˆ¬èŸ²èƒ½ç´¢å¼•æ‰€æœ‰å…§å®¹
- **æ¨™é¡Œè‡ªå‹•å¸¶å…¥ä¸ƒå¤§é¡é—œéµå­—**

```
ç›®æ¨™é—œéµå­—ç¯„ä¾‹ï¼š
- ã€Œå°å—æ±å€ä¸€æ—¥éŠï½œç¾é£Ÿã€æ™¯é»ã€è³¼ç‰©ç²¾é¸è·¯ç·šã€
- ã€Œå°ä¸­åŒ—å€ä¸€æ—¥éŠï½œç¾é£Ÿã€æ™¯é»ã€è³¼ç‰©ç²¾é¸è·¯ç·šã€
```

### 1.2 è³‡æ–™ä¾†æº

ç¾æœ‰ `gacha_ai_logs` è¡¨å·²å„²å­˜æ‰€éœ€è³‡æ–™ï¼š

| æ¬„ä½ | ç”¨é€” |
|------|------|
| `city` | åŸå¸‚ï¼ˆå¦‚ã€Œå°å—å¸‚ã€ï¼‰ |
| `district` | å€åŸŸï¼ˆå¦‚ã€Œæ±å€ã€ï¼‰ |
| `aiReason` | **AI æ’åºç†ç”±** â†’ ç›´æ¥ä½œç‚ºè¡Œç¨‹ä»‹ç´¹ |
| `orderedPlaceIds` | æ’åºå¾Œæ™¯é» ID â†’ é¡¯ç¤ºæ™¯é»å¡ç‰‡ |
| `categoryDistribution` | åˆ†é¡åˆ†ä½ˆ â†’ è‡ªå‹•ç”Ÿæˆæ¨™é¡Œé—œéµå­— |

**ç¯„ä¾‹ aiReason**ï¼š
> ã€Œè¡Œç¨‹é›†ä¸­æ–¼å°å—æ±å€ã€‚æ—©æ™¨å…ˆè‡³å¾Œç”²åœ“ç’°äº«ç”¨åœ¨åœ°è™±ç›®é­šæ—©é¤ï¼Œæ¥è‘—åˆ°é„°è¿‘çš„å°æ±å…¬åœ’æ•£æ­¥ã€‚ä¸‹åˆå®‰æ’DIYæ‰‹ä½œé«”é©—...ã€

### 1.3 è³‡æ–™æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶åœ¨ App æ‰­è›‹                                                 â”‚
â”‚         â†“                                                       â”‚
â”‚  gacha_ai_logs å„²å­˜ï¼ˆç¾æœ‰æµç¨‹ï¼‰                                  â”‚
â”‚  â”œâ”€â”€ city, district                                             â”‚
â”‚  â”œâ”€â”€ aiReasonï¼ˆAI æ’åºç†ç”±ï¼‰                                    â”‚
â”‚  â”œâ”€â”€ orderedPlaceIds                                            â”‚
â”‚  â””â”€â”€ categoryDistribution                                       â”‚
â”‚         â†“                                                       â”‚
â”‚  ã€æ–°å¢ã€‘åŒæ­¥åˆ° seo_itineraries                                  â”‚
â”‚  â”œâ”€â”€ è‡ªå‹•ç”Ÿæˆ titleï¼ˆå¸¶ä¸ƒå¤§é¡é—œéµå­—ï¼‰                            â”‚
â”‚  â”œâ”€â”€ è‡ªå‹•ç”Ÿæˆ slug                                              â”‚
â”‚  â””â”€â”€ æ­¸é¡åˆ°å°æ‡‰èšåˆé                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®˜æ–¹ç¶²ç«™ (Next.js)                                              â”‚
â”‚                                                                  â”‚
â”‚  èšåˆé ï¼š/itinerary/tainan-east                                  â”‚
â”‚  â”œâ”€â”€ æ¨™é¡Œï¼šå°å—æ±å€ä¸€æ—¥éŠï½œç¾é£Ÿã€æ™¯é»ã€è³¼ç‰©ç²¾é¸è·¯ç·š               â”‚
â”‚  â””â”€â”€ å¤šå€‹è¡Œç¨‹å¡ç‰‡é è¦½ â†’ é€£çµåˆ°å­é                                â”‚
â”‚                                                                  â”‚
â”‚  å­é ï¼š/itinerary/tainan-east/v001                               â”‚
â”‚  â”œâ”€â”€ AI ä»‹ç´¹ï¼ˆaiReasonï¼‰                                         â”‚
â”‚  â”œâ”€â”€ æ™¯é»å¡ç‰‡ï¼ˆæ²¿ç”¨ App æ¨£å¼ï¼‰                                   â”‚
â”‚  â””â”€â”€ ä¸æ”¾å•†å®¶ CTAï¼ˆä¿æŒç´”æ·¨ï¼‰                                    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ sitemap.xml â”‚ + â”‚ Schema.org JSON-LD      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 é é¢çµæ§‹

| é¡å‹ | URL ç¯„ä¾‹ | å…§å®¹ |
|------|----------|------|
| **èšåˆé ** | `/itinerary/tainan-east` | å°å—æ±å€æ‰€æœ‰è¡Œç¨‹ç¸½è¦½ |
| **å­é ** | `/itinerary/tainan-east/v001` | å–®ä¸€è¡Œç¨‹è©³æƒ… |

### 1.5 æ¨™é¡Œè‡ªå‹•ç”Ÿæˆé‚è¼¯

æ ¹æ“š `categoryDistribution` å–å‰ 3 å€‹åˆ†é¡ï¼š

```javascript
// è¼¸å…¥ï¼š{ ç¾é£Ÿ: 3, æ™¯é»: 1, è³¼ç‰©: 1 }
// è¼¸å‡ºï¼šã€Œå°å—æ±å€ä¸€æ—¥éŠï½œç¾é£Ÿã€æ™¯é»ã€è³¼ç‰©ç²¾é¸è·¯ç·šã€

function generateTitle(city, district, categoryDistribution) {
  const topCategories = Object.entries(categoryDistribution)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([cat]) => cat)
    .join('ã€');
  
  return `${city}${district}ä¸€æ—¥éŠï½œ${topCategories}ç²¾é¸è·¯ç·š`;
}
```

### 1.6 Slug ç”Ÿæˆè¦å‰‡

| åŸå¸‚ | å€åŸŸ | èšåˆé  slug | å­é  slug |
|------|------|-------------|-----------|
| å°å—å¸‚ | æ±å€ | `tainan-east` | `tainan-east/v001` |
| å°ä¸­å¸‚ | åŒ—å€ | `taichung-north` | `taichung-north/v002` |

### 1.7 å•†å®¶ SEO ç­–ç•¥

**è¡Œç¨‹é ä¿æŒç´”æ·¨**ï¼Œä¸æ”¾å•†å®¶ CTAï¼ˆé¿å…ç”¨æˆ¶èª¤ä»¥ç‚ºæ¨è–¦ä»˜è²»å•†å®¶ï¼‰ã€‚

å•†å®¶ SEO é ç¨ç«‹é é¢ï¼š

| é é¢ | URL | ç›®æ¨™é—œéµå­— |
|------|-----|-----------|
| å•†å®¶åˆä½œé  | `/for-business` | æ—…éŠè¡ŒéŠ·ã€åº—å®¶æ›å…‰ã€Mibu åˆä½œ |

è¡Œç¨‹é åªåœ¨ **Footer** æ”¾ã€Œæˆ‘æ˜¯å•†å®¶ã€é€£çµã€‚

### 1.8 åŒæ­¥è§¸ç™¼æ™‚æ©Ÿ

- **è‡ªå‹•è§¸ç™¼**ï¼šæ¯æ¬¡æ‰­è›‹å®Œæˆå¾Œ
- **è‡ªå‹•ç™¼å¸ƒ**ï¼šä¸éœ€äººå·¥å¯©æ ¸
- **æ¢ä»¶éæ¿¾**ï¼šåªåŒæ­¥æœ‰å®Œæ•´ aiReason çš„è¨˜éŒ„

### 1.9 `seo_itineraries` è³‡æ–™è¡¨

```typescript
// shared/schema.ts æ–°å¢
export const seoItineraries = pgTable("seo_itineraries", {
  id: serial("id").primaryKey(),
  
  // é—œè¯ gacha_ai_logs
  gachaSessionId: varchar("gacha_session_id", { length: 36 }).notNull(),
  
  // åœ°å€è³‡è¨Šï¼ˆå¾ gacha_ai_logs åŒæ­¥ï¼‰
  city: text("city").notNull(),
  district: text("district"),
  
  // SEO å…§å®¹ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
  slug: text("slug").notNull(),               // å­é  slug: "tainan-east/v001"
  parentSlug: text("parent_slug").notNull(),  // èšåˆé  slug: "tainan-east"
  title: text("title").notNull(),             // è‡ªå‹•ç”Ÿæˆæ¨™é¡Œ
  metaDescription: text("meta_description"),
  
  // å…§å®¹ï¼ˆå¾ gacha_ai_logs.aiReason åŒæ­¥ï¼‰
  itineraryIntro: text("itinerary_intro").notNull(),
  
  // æ™¯é»è³‡è¨Š
  placeIds: integer("place_ids").array(),
  categoryDistribution: jsonb("category_distribution"),
  
  // ç‹€æ…‹ï¼ˆè‡ªå‹•ç™¼å¸ƒï¼‰
  status: text("status").default("published"),
  publishedAt: timestamp("published_at").defaultNow(),  // ç™¼å¸ƒæ™‚é–“ï¼ˆè‡ªå‹•è¨­å®šï¼‰
  
  // æ™‚é–“æˆ³
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### 1.10 å®˜ç¶²é é¢çµæ§‹

```
/                                    # é¦–é 
/itinerary                           # æ‰€æœ‰åŸå¸‚åˆ—è¡¨
/itinerary/[parentSlug]              # èšåˆé ï¼šå¦‚ /itinerary/tainan-east
/itinerary/[parentSlug]/[version]    # å­é ï¼šå¦‚ /itinerary/tainan-east/v001

/for-business                        # å•†å®¶åˆä½œé ï¼ˆç¨ç«‹ SEOï¼‰

/sitemap.xml                         # å‹•æ…‹ Sitemap
/robots.txt                          # çˆ¬èŸ²è¦å‰‡
```

### 1.11 API ç«¯é»

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | /api/seo/itineraries | åˆ—å‡ºæ‰€æœ‰å·²ç™¼å¸ƒè¡Œç¨‹ |
| GET | /api/seo/itineraries/:parentSlug | å–å¾—èšåˆé ä¸‹æ‰€æœ‰å­é  |
| GET | /api/seo/itineraries/:parentSlug/:version | å–å¾—å–®ä¸€å­é  |
| GET | /api/seo/sitemap | å–å¾— Sitemap è³‡æ–™ |

### 1.12 åŒæ­¥é‚è¼¯èˆ‡ ISR é‡æ–°é©—è­‰

#### 1.12.1 å»é‡æ©Ÿåˆ¶ï¼ˆSEO å…§å®¹å“è³ªæ§åˆ¶ï¼‰

åŒå€åŸŸæ™¯é»é‡è¤‡ç‡ > 70% æ™‚è·³éåŒæ­¥ï¼Œç¢ºä¿æ¯å€‹èšåˆé ä¸‹çš„å­é å…§å®¹æœ‰å·®ç•°æ€§ã€‚

```typescript
// è¨ˆç®—æ™¯é»é‡è¤‡ç‡
function calculatePlaceOverlap(a: number[], b: number[]): number {
  if (!a?.length || !b?.length) return 0;
  const setA = new Set(a);
  const setB = new Set(b);
  const intersection = [...setA].filter(x => setB.has(x));
  const smaller = Math.min(a.length, b.length);
  return smaller === 0 ? 0 : intersection.length / smaller;
}

// æª¢æŸ¥æ˜¯å¦ç‚ºé‡è¤‡å…§å®¹
async function isDuplicateContent(
  parentSlug: string, 
  placeIds: number[]
): Promise<boolean> {
  const existing = await db.query.seoItineraries.findMany({
    where: eq(seoItineraries.parentSlug, parentSlug),
  });
  
  for (const item of existing) {
    const overlap = calculatePlaceOverlap(item.placeIds || [], placeIds);
    if (overlap > 0.7) return true; // 70% ä»¥ä¸Šæ™¯é»é‡è¤‡ï¼Œè¦–ç‚ºé‡è¤‡
  }
  
  return false;
}
```

#### 1.12.2 Slug ä½µç™¼å®‰å…¨æ©Ÿåˆ¶

**è³‡æ–™è¡¨ç´„æŸ**ï¼š
```sql
-- ç¢ºä¿ slug å”¯ä¸€
CREATE UNIQUE INDEX idx_seo_itineraries_slug ON seo_itineraries(slug);

-- ç¢ºä¿ gachaSessionId å”¯ä¸€ï¼ˆé¿å…åŒä¸€æ‰­è›‹é‡è¤‡åŒæ­¥ï¼‰
CREATE UNIQUE INDEX idx_seo_itineraries_session ON seo_itineraries(gacha_session_id);
```

**äº¤æ˜“é–å®š**ï¼š
```typescript
// ä½¿ç”¨è³‡æ–™åº«äº¤æ˜“ + åºåˆ—åŒ–éš”é›¢ç¢ºä¿ç‰ˆæœ¬è™Ÿä¸è¡çª
async function getNextVersionSafe(parentSlug: string): Promise<number> {
  return await db.transaction(async (tx) => {
    const latest = await tx.query.seoItineraries.findFirst({
      where: eq(seoItineraries.parentSlug, parentSlug),
      orderBy: desc(seoItineraries.createdAt),
    });
    
    // è§£æç¾æœ‰ç‰ˆæœ¬è™Ÿ
    if (!latest) return 1;
    const match = latest.slug.match(/v(\d+)$/);
    return match ? parseInt(match[1]) + 1 : 1;
  }, { isolationLevel: 'serializable' });
}
```

#### 1.12.3 å®Œæ•´åŒæ­¥æµç¨‹ï¼ˆå«è‡ªå‹• ISR è§¸ç™¼ï¼‰

```typescript
// æ‰­è›‹å®Œæˆå¾Œè‡ªå‹•åŒæ­¥
async function syncToSeoItineraries(gachaLog: GachaAiLog) {
  // 1. åªåŒæ­¥æœ‰ aiReason çš„è¨˜éŒ„
  if (!gachaLog.aiReason) return;
  
  const parentSlug = generateParentSlug(gachaLog.city, gachaLog.district);
  
  // 2. å»é‡æª¢æŸ¥ï¼šåŒå€åŸŸæ™¯é»é‡è¤‡ç‡ > 70% å‰‡è·³é
  const isDuplicate = await isDuplicateContent(parentSlug, gachaLog.orderedPlaceIds);
  if (isDuplicate) {
    console.log(`Skipped: ${parentSlug} - duplicate content (>70% overlap)`);
    return;
  }
  
  // 3. ä½¿ç”¨äº¤æ˜“ç¢ºä¿ç‰ˆæœ¬è™Ÿä¸è¡çª
  const version = await getNextVersionSafe(parentSlug);
  const slug = `${parentSlug}/v${version.toString().padStart(3, '0')}`;
  
  // 4. è‡ªå‹•ç”Ÿæˆæ¨™é¡Œ
  const title = generateTitle(
    gachaLog.city, 
    gachaLog.district, 
    gachaLog.categoryDistribution
  );
  
  // 5. å­˜å…¥ seo_itineraries
  await db.insert(seoItineraries).values({
    gachaSessionId: gachaLog.sessionId,
    city: gachaLog.city,
    district: gachaLog.district,
    slug,
    parentSlug,
    title,
    itineraryIntro: gachaLog.aiReason,
    placeIds: gachaLog.orderedPlaceIds,
    categoryDistribution: gachaLog.categoryDistribution,
    status: 'published',
  });
  
  // 6. ã€é‡è¦ã€‘è‡ªå‹•è§¸ç™¼ ISR é‡æ–°é©—è­‰
  await triggerISRRevalidation(slug, parentSlug);
}

// Slug ç”Ÿæˆï¼ˆåŸå¸‚+å€åŸŸ â†’ è‹±æ–‡ï¼‰
function generateParentSlug(city: string, district?: string): string {
  const cityMap: Record<string, string> = {
    'å°å—å¸‚': 'tainan', 'å°ä¸­å¸‚': 'taichung', 'å°åŒ—å¸‚': 'taipei', ...
  };
  const districtMap: Record<string, string> = {
    'æ±å€': 'east', 'åŒ—å€': 'north', 'å¤§å®‰å€': 'daan', ...
  };
  
  const citySlug = cityMap[city] || city;
  const districtSlug = district ? districtMap[district] || district : '';
  
  return districtSlug ? `${citySlug}-${districtSlug}` : citySlug;
}
```

#### 1.12.4 ISR é‡æ–°é©—è­‰å‡½å¼

```typescript
const triggerISRRevalidation = async (slug: string, parentSlug: string) => {
  const OFFICIAL_SITE_URL = process.env.OFFICIAL_SITE_URL;
  const REVALIDATE_SECRET = process.env.REVALIDATE_SECRET;
  
  if (!OFFICIAL_SITE_URL) return; // é–‹ç™¼ç’°å¢ƒå¯è·³é
  
  try {
    await fetch(`${OFFICIAL_SITE_URL}/api/revalidate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Revalidate-Secret': REVALIDATE_SECRET,
      },
      body: JSON.stringify({
        paths: [
          `/itinerary/${slug}`,          // å­é 
          `/itinerary/${parentSlug}`,    // èšåˆé 
          '/itinerary',                  // åŸå¸‚åˆ—è¡¨é 
          '/sitemap.xml',                // Sitemap
        ],
      }),
    });
  } catch (error) {
    console.error('ISR revalidation failed:', error);
    // ä¸ä¸­æ–·ä¸»æµç¨‹ï¼ŒISR å¤±æ•—æ™‚é é¢ä»æœƒåœ¨ revalidate æ™‚é–“å¾Œè‡ªå‹•æ›´æ–°
  }
};
```

#### å®˜ç¶² Next.js Revalidation API

```typescript
// app/api/revalidate/route.ts (Next.js å®˜ç¶²)
import { revalidatePath } from 'next/cache';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const secret = request.headers.get('X-Revalidate-Secret');
  
  // é©—è­‰ secret
  if (secret !== process.env.REVALIDATE_SECRET) {
    return NextResponse.json({ error: 'Invalid secret' }, { status: 401 });
  }
  
  const { paths } = await request.json();
  
  // é‡æ–°é©—è­‰æŒ‡å®šè·¯å¾‘
  for (const path of paths) {
    revalidatePath(path);
  }
  
  return NextResponse.json({ revalidated: true, paths });
}
```

#### ISR é…ç½®

```typescript
// app/itinerary/[slug]/page.tsx
export const revalidate = 3600; // 1 å°æ™‚è‡ªå‹•é‡æ–°é©—è­‰

// æˆ–ä½¿ç”¨ generateStaticParams é€²è¡Œ SSG
export async function generateStaticParams() {
  const itineraries = await fetchAllPublishedItineraries();
  return itineraries.map((i) => ({ slug: i.slug }));
}
```

---

## ğŸ’³ åŠŸèƒ½äºŒï¼šå•†å®¶è¨‚é–±åˆ¶

### 2.1 è¨‚é–±æ–¹æ¡ˆå®šç¾©

æ ¹æ“šç”¨æˆ¶æä¾›çš„è¦æ ¼ï¼š

#### å•†å®¶ç­‰ç´šï¼ˆMerchant Tierï¼‰
| ç­‰ç´š | åƒ¹æ ¼ | è¡Œç¨‹å¡æ•¸é‡ | æ•¸æ“šåˆ†æ | å•†å“ç®¡ç† |
|------|------|-----------|---------|---------|
| Free | $0 | 1 | âŒ | âœ… |
| Pro | $299/æœˆ | 5 | âœ… | âœ… |
| Premium | $799/æœˆ | 20 | âœ… | âœ… |

#### è¡Œç¨‹å¡ç­‰ç´šï¼ˆPlace Card Tierï¼‰
| ç­‰ç´š | åƒ¹æ ¼ | å¤–æ¡† | å„ªæƒ è³‡è¨Š | å„ªæƒ åˆ¸æ–¹æ¡ˆæ•¸ | å¯é¸ç¨€æœ‰åº¦ | åœ–ç‰‡ç·¨è¼¯ |
|------|------|-----|---------|-------------|-----------|---------|
| Free | $0 | âŒ | âŒ | 1 | R | å„ªæƒ åˆ¸èƒŒæ™¯ |
| Pro | $199/æœˆ | âœ… | âœ… | 5 | SSR/SR/S/R | å„ªæƒ åˆ¸+é“å…·ç®± |
| Premium | $399/æœˆ | âœ… + ç‰¹æ•ˆ | âœ… | 10 | SP/SSR/SR/S/R | å„ªæƒ åˆ¸+é“å…·ç®± |

### 2.2 è³‡æ–™è¡¨ä¿®æ”¹

> **é‡è¦**ï¼šæ²¿ç”¨ç¾æœ‰ `merchants.merchantLevel` æ¬„ä½æ§åˆ¶å•†å®¶ç­‰ç´š

#### ä¿®æ”¹ `merchants` è¡¨ï¼ˆæ–°å¢ 3 å€‹æ¬„ä½ï¼‰
```typescript
// æ²¿ç”¨ç¾æœ‰æ¬„ä½ï¼šmerchantLevel: varchar("merchant_level", { length: 20 }).default('free')
// æ–°å¢æ¬„ä½ï¼š
merchantLevelExpiresAt: timestamp("merchant_level_expires_at"),
stripeCustomerId: varchar("stripe_customer_id", { length: 255 }),
recurCustomerId: varchar("recur_customer_id", { length: 255 }),
```

#### ä¿®æ”¹ `places` è¡¨ï¼ˆæ–°å¢ 2 å€‹æ¬„ä½ï¼‰
```typescript
// è¡Œç¨‹å¡ç­‰ç´šï¼ˆç›´æ¥å­˜æ–¼ places è¡¨ï¼Œç„¡éœ€é¡å¤–è¡¨ï¼‰
placeCardTier: varchar("place_card_tier", { length: 20 }).default('free'),
placeCardTierExpiresAt: timestamp("place_card_tier_expires_at"),
```

#### æ–°å¢ `merchant_subscriptions` è¡¨
```typescript
export const merchantSubscriptions = pgTable("merchant_subscriptions", {
  id: serial("id").primaryKey(),
  merchantId: integer("merchant_id").references(() => merchants.id).notNull(),
  
  // è¨‚é–±é¡å‹
  type: varchar("type", { length: 20 }).notNull(), // 'merchant' | 'place'
  tier: varchar("tier", { length: 20 }).notNull(), // 'pro' | 'premium'
  placeId: integer("place_id").references(() => places.id), // null for merchant subscription
  
  // é‡‘æµè³‡è¨Š
  provider: varchar("provider", { length: 20 }).notNull(), // 'stripe' | 'recur'
  providerSubscriptionId: varchar("provider_subscription_id", { length: 255 }).notNull(),
  providerCustomerId: varchar("provider_customer_id", { length: 255 }),
  
  // ç‹€æ…‹
  status: varchar("status", { length: 20 }).default("active").notNull(),
  currentPeriodStart: timestamp("current_period_start"),
  currentPeriodEnd: timestamp("current_period_end"),
  scheduledDowngradeTo: varchar("scheduled_downgrade_to", { length: 20 }),
  cancelAtPeriodEnd: boolean("cancel_at_period_end").default(false),
  
  // åƒ¹æ ¼
  amount: integer("amount"),
  currency: varchar("currency", { length: 10 }).default("TWD"),
  lastPaymentIntentId: varchar("last_payment_intent_id", { length: 255 }),
  
  // æ™‚é–“æˆ³
  cancelledAt: timestamp("cancelled_at"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

### 2.3 é‡‘æµæ•´åˆæ¶æ§‹

**é‡è¦ï¼šé‡‘æµç”±ç”¨æˆ¶è‡ªè¡Œé¸æ“‡ï¼Œéè‡ªå‹•å°å‘**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®˜æ–¹ç¶²ç«™ (Replit)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¨‚é–±è³¼è²·é é¢                                             â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼š                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’³ ä¿¡ç”¨å¡       â”‚    â”‚  ğŸ¦ å°ç£åœ¨åœ°    â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  (Stripe)       â”‚    â”‚  (Recur/PAYUNi) â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚          â†“                      â†“                        â”‚   â”‚
â”‚  â”‚      ç”¨æˆ¶è‡ªè¡Œé»é¸è¦ä½¿ç”¨çš„ä»˜æ¬¾æ–¹å¼                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡‘æµæœå‹™ï¼ˆç”¨æˆ¶é¸æ“‡ï¼‰        â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Stripe         â”‚    â”‚ Recur (PAYUNi)  â”‚                      â”‚
â”‚  â”‚ (ä¿¡ç”¨å¡)       â”‚    â”‚ (å°ç£åœ¨åœ°æ”¯ä»˜)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚          â”‚                      â”‚                               â”‚
â”‚          â†“                      â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Webhook æ¥æ”¶                               â”‚                  â”‚
â”‚  â”‚ POST /api/webhooks/stripe                  â”‚                  â”‚
â”‚  â”‚ POST /api/webhooks/recur                   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾Œç«¯ (æœ¬å°ˆæ¡ˆ)           â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ è¨‚é–±ç‹€æ…‹æ›´æ–°                               â”‚                  â”‚
â”‚  â”‚ - æ›´æ–° merchant_subscriptions              â”‚                  â”‚
â”‚  â”‚ - æ›´æ–° merchants.merchantLevel             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ æ¬Šé™åŒæ­¥æ©Ÿåˆ¶                               â”‚                  â”‚
â”‚  â”‚ - Socket.io å³æ™‚æ¨é€                       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Expo App               â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ æ¥æ”¶æ¬Šé™æ›´æ–°                               â”‚                  â”‚
â”‚  â”‚ - åˆ·æ–°å•†å®¶ session                         â”‚                  â”‚
â”‚  â”‚ - è§£é–å°æ‡‰åŠŸèƒ½                             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Recur æ•´åˆï¼ˆç¾æœ‰åŸºç¤ï¼‰

æ ¹æ“š `server/routes.ts` ç¬¬ 2192-2372 è¡Œï¼Œå·²æœ‰ï¼š
- `RECUR_API_URL = "https://api.recur.tw/v1"`
- `POST /api/recur/checkout` - å»ºç«‹çµå¸³
- `POST /api/webhooks/recur` - Webhook è™•ç†
- `GET /api/webhooks/recur/info` - Webhook è³‡è¨Š

**éœ€è¦è£œå®Œçš„éƒ¨åˆ†ï¼š**
1. å•†å®¶è¨‚é–±å°ˆç”¨ Price ID è¨­å®š
2. è¨‚é–±ç‹€æ…‹åŒæ­¥é‚è¼¯
3. å–æ¶ˆè¨‚é–±è™•ç†

### 2.5 Stripe æ•´åˆï¼ˆç¾æœ‰åŸºç¤ï¼‰

å·²æœ‰å®Œæ•´ Stripe æ•´åˆï¼Œéœ€æ–°å¢ï¼š
1. å•†å®¶è¨‚é–± Price IDï¼ˆStripe Dashboard å»ºç«‹ï¼‰
2. è¨‚é–± Webhook äº‹ä»¶è™•ç†
3. ç”¨æˆ¶é¢å‘çš„è¨‚é–±ç®¡ç†é é¢

### 2.6 API ç«¯é»

| Method | Endpoint | èªªæ˜ | èªè­‰ |
|--------|----------|------|------|
| GET | /api/merchant/subscription | å–å¾—ç•¶å‰è¨‚é–±ç‹€æ…‹ | Merchant JWT |
| POST | /api/merchant/subscription/checkout | å»ºç«‹è¨‚é–±çµå¸³ | Merchant JWT |
| POST | /api/merchant/subscription/cancel | å–æ¶ˆè¨‚é–± | Merchant JWT |
| POST | /api/merchant/subscription/upgrade | å‡ç´šæ–¹æ¡ˆ | Merchant JWT |
| POST | /api/webhooks/stripe | Stripe Webhook | Signature |
| POST | /api/webhooks/recur | Recur Webhook | Signature |

### 2.7 æ¬Šé™åŒæ­¥æ©Ÿåˆ¶

#### æ–¹æ¡ˆ Aï¼šSocket.io å³æ™‚æ¨é€ï¼ˆæ¨è–¦ï¼‰
```typescript
// å¾Œç«¯ï¼šWebhook è™•ç†å®Œæˆå¾Œ
io.to(`merchant:${merchantId}`).emit('subscription:updated', {
  merchantLevel: 'pro',
  placeCardTier: 'premium',
  expiresAt: '2026-02-05T00:00:00Z'
});

// App ç«¯ï¼šç›£è½äº‹ä»¶
socket.on('subscription:updated', (data) => {
  updateMerchantSession(data);
  refreshUI();
});
```

#### æ–¹æ¡ˆ Bï¼šPush Notification + API åˆ·æ–°
```typescript
// å¾Œç«¯ï¼šç™¼é€æ¨æ’­
await pushNotification.send(merchantUserId, {
  title: 'è¨‚é–±å·²å‡ç´š',
  body: 'æ‚¨çš„ Pro æ–¹æ¡ˆå·²ç”Ÿæ•ˆ',
  data: { action: 'refresh_subscription' }
});

// App ç«¯ï¼šæ”¶åˆ°æ¨æ’­å¾Œèª¿ç”¨ API
GET /api/merchant/subscription â†’ æ›´æ–°æœ¬åœ°ç‹€æ…‹
```

---

## ğŸ” å®‰å…¨æ€§è¨­è¨ˆ

### 3.1 èªè­‰æ©Ÿåˆ¶

| å ´æ™¯ | èªè­‰æ–¹å¼ | èªªæ˜ |
|------|---------|------|
| å®˜ç¶² SEO é é¢ | Service Token | å¾Œç«¯ç™¼çµ¦å®˜ç¶²çš„éœæ…‹ Token |
| å•†å®¶ç™»å…¥ | JWT | èˆ‡ App å…±ç”¨èªè­‰ç³»çµ± |
| Webhook | Signature | Stripe/Recur ç°½åé©—è­‰ |
| Admin API | JWT + Role Check | éœ€ admin è§’è‰² |

### 3.2 ç’°å¢ƒè®Šæ•¸

```bash
# ç¾æœ‰
STRIPE_SECRET_KEY=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...

# éœ€æ–°å¢
RECUR_SECRET_KEY=sk_...          # Recur ç§é‘°
RECUR_PUBLISHABLE_KEY=pk_...     # Recur å…¬é‘°
RECUR_WEBHOOK_SECRET=...         # Recur Webhook ç°½å
SEO_SERVICE_TOKEN=...            # å®˜ç¶²å‘¼å«å¾Œç«¯ API çš„ Token

# Stripe å•†å®¶è¨‚é–± Price ID
STRIPE_MERCHANT_PRO_PRICE_ID=price_...
STRIPE_MERCHANT_PREMIUM_PRICE_ID=price_...
STRIPE_PLACE_PRO_PRICE_ID=price_...
STRIPE_PLACE_PREMIUM_PRICE_ID=price_...

# Recur å•†å®¶è¨‚é–± Product ID
RECUR_MERCHANT_PRO_PRODUCT_ID=prod_...
RECUR_MERCHANT_PREMIUM_PRODUCT_ID=prod_...
RECUR_PLACE_PRO_PRODUCT_ID=prod_...
RECUR_PLACE_PREMIUM_PRODUCT_ID=prod_...
```

---

## ğŸ”„ è³‡æ–™åº«é·ç§»è¨ˆç•«

### 4.1 ç¾æ³åˆ†æ

ç¶“ç¨‹å¼ç¢¼æƒæç¢ºèª `merchants` è¡¨å·²æœ‰æ¬„ä½ï¼š
- `subscriptionPlan`: text, default 'free' â€” èˆŠæ¬„ä½ï¼Œä¿ç•™å‘ä¸‹ç›¸å®¹
- `merchantLevel`: varchar(20), default 'free' â€” **æ²¿ç”¨æ­¤æ¬„ä½æ§åˆ¶å•†å®¶ç­‰ç´š**

### 4.2 éœ€æ–°å¢çš„æ¬„ä½

```sql
-- merchants è¡¨æ–°å¢æ¬„ä½ï¼ˆæ²¿ç”¨ merchantLevelï¼‰
ALTER TABLE merchants ADD COLUMN merchant_level_expires_at TIMESTAMP;
ALTER TABLE merchants ADD COLUMN stripe_customer_id VARCHAR(255);
ALTER TABLE merchants ADD COLUMN recur_customer_id VARCHAR(255);

-- places è¡¨æ–°å¢æ¬„ä½ï¼ˆè¡Œç¨‹å¡ç­‰ç´šï¼‰
ALTER TABLE places ADD COLUMN place_card_tier VARCHAR(20) DEFAULT 'free';
ALTER TABLE places ADD COLUMN place_card_tier_expires_at TIMESTAMP;
```

### 4.3 é·ç§»æ­¥é©Ÿ

| æ­¥é©Ÿ | å‹•ä½œ | é¢¨éšª |
|------|------|------|
| 1 | æ–°å¢ `seo_itineraries` è¡¨ | ç„¡ï¼ˆæ–°è¡¨ï¼‰ |
| 2 | æ–°å¢ `merchant_subscriptions` è¡¨ | ç„¡ï¼ˆæ–°è¡¨ï¼‰ |
| 3 | `merchants` è¡¨æ–°å¢ 3 å€‹æ¬„ä½ | ä½ï¼ˆç´”æ–°å¢ï¼Œæœ‰é è¨­å€¼ï¼‰ |
| 4 | `places` è¡¨æ–°å¢ 2 å€‹æ¬„ä½ | ä½ï¼ˆç´”æ–°å¢ï¼Œæœ‰é è¨­å€¼ï¼‰ |
| 5 | åŸ·è¡Œ `npm run db:push` | ä½ï¼ˆå®‰å…¨åŒæ­¥ï¼‰ |
| 6 | éƒ¨ç½²æ–° API ç«¯é» | ä½ï¼ˆæ–°ç«¯é»ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½ï¼‰ |
| 7 | å•Ÿç”¨ Webhook è™•ç† | ä¸­ï¼ˆéœ€æ¸¬è©¦é‡‘æµï¼‰ |

### 4.4 å›æ»¾æ–¹æ¡ˆ

è‹¥å‡ºç¾å•é¡Œï¼š
```sql
-- å›æ»¾ï¼šç§»é™¤æ–°å¢çš„æ¬„ä½
ALTER TABLE merchants DROP COLUMN merchant_level_expires_at;
ALTER TABLE merchants DROP COLUMN stripe_customer_id;
ALTER TABLE merchants DROP COLUMN recur_customer_id;
ALTER TABLE places DROP COLUMN place_card_tier;
ALTER TABLE places DROP COLUMN place_card_tier_expires_at;

-- å›æ»¾ï¼šåˆªé™¤æ–°è¡¨
DROP TABLE IF EXISTS merchant_subscriptions;
DROP TABLE IF EXISTS seo_itineraries;
```

---

## ğŸ” è¨‚é–±ç”Ÿå‘½é€±æœŸ

### 5.1 è¨‚é–±ç‹€æ…‹æµç¨‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å»ºç«‹è¨‚é–±   â”‚
                    â”‚  (checkout) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â†“                               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ä»˜æ¬¾æˆåŠŸ    â”‚                 â”‚ ä»˜æ¬¾å¤±æ•—    â”‚
    â”‚ â†’ active    â”‚                 â”‚ â†’ cancelled â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ­£å¸¸ä½¿ç”¨   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â†“     â†“     â†“         â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªå‹•çºŒç´„â”‚ â”‚ å‡ç´š   â”‚ â”‚ é™ç´š   â”‚ â”‚ å–æ¶ˆçºŒç´„ â”‚ â”‚ åˆ°æœŸ   â”‚
â”‚â†’ activeâ”‚ â”‚â†’ activeâ”‚ â”‚â†’ activeâ”‚ â”‚â†’ cancelingâ”‚ â”‚â†’ expiredâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç‹€æ…‹å®šç¾©

| ç‹€æ…‹ | èªªæ˜ | æ¬Šé™ |
|------|------|------|
| `active` | è¨‚é–±æœ‰æ•ˆ | å®Œæ•´æ¬Šé™ |
| `past_due` | ä»˜æ¬¾å¤±æ•—ï¼Œå¯¬é™æœŸ | å®Œæ•´æ¬Šé™ï¼ˆ3 å¤©å¯¬é™ï¼‰ |
| `canceling` | å·²å–æ¶ˆçºŒç´„ï¼ŒæœŸé™å…§ä»æœ‰æ•ˆ | å®Œæ•´æ¬Šé™è‡³åˆ°æœŸæ—¥ |
| `expired` | å·²åˆ°æœŸ | é™ç‚º Free æ¬Šé™ |
| `cancelled` | å·²å–æ¶ˆï¼ˆç«‹å³å¤±æ•ˆï¼‰ | é™ç‚º Free æ¬Šé™ |

### 5.3 é›™é‡‘æµ Webhook äº‹ä»¶æ˜ å°„è¡¨

> **çµ±ä¸€è™•ç†**ï¼šStripe å’Œ Recur çš„äº‹ä»¶åç¨±ä¸åŒï¼Œéœ€é€éæ­¤æ˜ å°„è¡¨è½‰æ›ç‚ºçµ±ä¸€çš„è¨‚é–±ç‹€æ…‹

| Stripe äº‹ä»¶ | Recur äº‹ä»¶ | çµ±ä¸€å‹•ä½œ | çµæœç‹€æ…‹ |
|------------|-----------|---------|---------|
| `checkout.session.completed` | `checkout.completed` | è¨‚é–±å»ºç«‹æˆåŠŸ | `active` |
| `invoice.paid` | `payment.success` | çºŒç´„æˆåŠŸ | `active` |
| `invoice.payment_failed` | `payment.failed` | çºŒç´„å¤±æ•— | `past_due` |
| `customer.subscription.updated` | `subscription.updated` | æ–¹æ¡ˆè®Šæ›´ | ä¾æ–°æ–¹æ¡ˆ |
| `customer.subscription.deleted` | `subscription.cancelled` | è¨‚é–±å–æ¶ˆ | `cancelled` |
| - | `subscription.expired` | è¨‚é–±åˆ°æœŸ | `expired` |

```typescript
// çµ±ä¸€ Webhook è™•ç†å…¥å£
type WebhookEvent = {
  provider: 'stripe' | 'recur';
  eventType: string;
  subscriptionId: string;
  data: any;
};

async function handleWebhookEvent(event: WebhookEvent) {
  // æ˜ å°„åˆ°çµ±ä¸€å‹•ä½œ
  const actionMap: Record<string, Record<string, string>> = {
    stripe: {
      'checkout.session.completed': 'subscription_created',
      'invoice.paid': 'renewal_success',
      'invoice.payment_failed': 'payment_failed',
      'customer.subscription.updated': 'subscription_updated',
      'customer.subscription.deleted': 'subscription_cancelled',
    },
    recur: {
      'checkout.completed': 'subscription_created',
      'payment.success': 'renewal_success',
      'payment.failed': 'payment_failed',
      'subscription.updated': 'subscription_updated',
      'subscription.cancelled': 'subscription_cancelled',
      'subscription.expired': 'subscription_expired',
    },
  };
  
  const action = actionMap[event.provider]?.[event.eventType];
  if (!action) return;
  
  switch (action) {
    case 'subscription_created':
      await handleSubscriptionCreated(event);
      break;
    case 'renewal_success':
      await handleRenewalSuccess(event.subscriptionId, event.provider);
      break;
    case 'payment_failed':
      await handlePaymentFailed(event.subscriptionId, event.provider);
      break;
    case 'subscription_updated':
      await handleSubscriptionUpdated(event);
      break;
    case 'subscription_cancelled':
    case 'subscription_expired':
      await handleSubscriptionEnded(event.subscriptionId, event.provider, action);
      break;
  }
  
  // æ‰€æœ‰ç‹€æ…‹è®Šæ›´å¾Œï¼Œé€šçŸ¥ App åŒæ­¥æ¬Šé™
  await notifyAppPermissionChange(event.subscriptionId);
}
```

### 5.4 ç”Ÿå‘½é€±æœŸäº‹ä»¶è™•ç†

> **æ¬„ä½å°æ‡‰**ï¼šä½¿ç”¨ç¾æœ‰ `merchants.merchantLevel` æ¬„ä½ï¼ˆéæ–°å¢ merchantTierï¼‰

#### è‡ªå‹•çºŒç´„æˆåŠŸ
```typescript
// Webhook: invoice.paid (Stripe) / payment.success (Recur)
async function handleRenewalSuccess(providerSubscriptionId: string, provider: 'stripe' | 'recur') {
  const subscription = await db.query.merchantSubscriptions.findFirst({
    where: and(
      eq(merchantSubscriptions.providerSubscriptionId, providerSubscriptionId),
      eq(merchantSubscriptions.provider, provider),
    ),
  });
  
  if (!subscription) return;
  
  await db.update(merchantSubscriptions)
    .set({
      status: 'active',
      currentPeriodStart: new Date(),
      currentPeriodEnd: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // +30 days
      updatedAt: new Date(),
    })
    .where(eq(merchantSubscriptions.id, subscription.id));
}
```

#### çºŒç´„å¤±æ•—
```typescript
// Webhook: invoice.payment_failed
async function handlePaymentFailed(providerSubscriptionId: string, provider: 'stripe' | 'recur') {
  const subscription = await db.query.merchantSubscriptions.findFirst({
    where: and(
      eq(merchantSubscriptions.providerSubscriptionId, providerSubscriptionId),
      eq(merchantSubscriptions.provider, provider),
    ),
  });
  
  if (!subscription) return;
  
  await db.update(merchantSubscriptions)
    .set({ status: 'past_due', updatedAt: new Date() })
    .where(eq(merchantSubscriptions.id, subscription.id));
  
  // è¨­å®š 3 å¤©å¯¬é™æœŸ
  const graceDeadline = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);
  
  // ç™¼é€é€šçŸ¥çµ¦å•†å®¶ï¼ˆé€éç¾æœ‰é€šçŸ¥ç³»çµ±ï¼‰
  await storage.createNotification({
    userId: subscription.merchantId.toString(), // éœ€è½‰æ›ç‚º user é—œè¯
    type: 'payment_failed',
    title: 'ä»˜æ¬¾å¤±æ•—',
    body: `æ‚¨çš„è¨‚é–±ä»˜æ¬¾å¤±æ•—ï¼Œè«‹åœ¨ ${graceDeadline.toLocaleDateString('zh-TW')} å‰æ›´æ–°ä»˜æ¬¾æ–¹å¼`,
  });
}
```

#### å‡ç´šæ–¹æ¡ˆ
```typescript
// API: POST /api/merchant/subscription/upgrade
async function upgradeSubscription(merchantId: number, newLevel: 'pro' | 'premium', provider: 'stripe' | 'recur') {
  // 1. ä½¿ç”¨è³‡æ–™åº«äº¤æ˜“ç¢ºä¿åŸå­æ€§
  await db.transaction(async (tx) => {
    // 2. æ›´æ–°å•†å®¶ç­‰ç´š
    await tx.update(merchants)
      .set({ 
        merchantLevel: newLevel,
        merchantLevelExpiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
        updatedAt: new Date(),
      })
      .where(eq(merchants.id, merchantId));
    
    // 3. æ›´æ–°è¨‚é–±è¨˜éŒ„
    await tx.update(merchantSubscriptions)
      .set({ 
        tier: newLevel, 
        updatedAt: new Date() 
      })
      .where(eq(merchantSubscriptions.merchantId, merchantId));
  });
  
  // 4. æ¨é€æ¬Šé™æ›´æ–°
  io.to(`merchant:${merchantId}`).emit('subscription:updated', { merchantLevel: newLevel });
}
```

#### é™ç´šæ–¹æ¡ˆ
```typescript
// é™ç´šåœ¨ç•¶æœŸçµæŸå¾Œç”Ÿæ•ˆï¼ˆé¿å…ç”¨æˆ¶æå¤±å·²ä»˜è²»æ¬Šç›Šï¼‰
async function downgradeSubscription(merchantId: number, newLevel: 'free' | 'pro') {
  const subscription = await db.query.merchantSubscriptions.findFirst({
    where: eq(merchantSubscriptions.merchantId, merchantId),
  });
  
  if (!subscription) return;
  
  // è¨˜éŒ„å¾…é™ç´šï¼Œä¸ç«‹å³ç”Ÿæ•ˆ
  await db.update(merchantSubscriptions)
    .set({ 
      scheduledDowngradeTo: newLevel,
      updatedAt: new Date(),
    })
    .where(eq(merchantSubscriptions.id, subscription.id));
  
  // åˆ°æœŸè™•ç†æ’ç¨‹æœƒæª¢æŸ¥æ­¤æ¬„ä½
}
```

#### åˆ°æœŸè™•ç†ï¼ˆæ’ç¨‹ä»»å‹™ï¼‰
```typescript
// æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼šserver/scripts/process-expired-subscriptions.ts
async function processExpiredSubscriptions() {
  const now = new Date();
  const gracePeriodEnd = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); // 3 å¤©å‰
  
  // 1. è™•ç†è¶…éå¯¬é™æœŸçš„ past_due è¨‚é–±
  const pastDueExpired = await db.query.merchantSubscriptions.findMany({
    where: and(
      eq(merchantSubscriptions.status, 'past_due'),
      lt(merchantSubscriptions.updatedAt, gracePeriodEnd),
    ),
  });
  
  for (const sub of pastDueExpired) {
    await db.transaction(async (tx) => {
      await tx.update(merchantSubscriptions)
        .set({ status: 'expired', updatedAt: now })
        .where(eq(merchantSubscriptions.id, sub.id));
      
      await tx.update(merchants)
        .set({ merchantLevel: 'free', merchantLevelExpiresAt: null, updatedAt: now })
        .where(eq(merchants.id, sub.merchantId));
    });
    
    io.to(`merchant:${sub.merchantId}`).emit('subscription:updated', { merchantLevel: 'free' });
  }
  
  // 2. è™•ç†å·²åˆ°æœŸçš„ active è¨‚é–±
  const activeExpired = await db.query.merchantSubscriptions.findMany({
    where: and(
      eq(merchantSubscriptions.status, 'active'),
      lt(merchantSubscriptions.currentPeriodEnd, now),
    ),
  });
  
  for (const sub of activeExpired) {
    const newLevel = sub.scheduledDowngradeTo || 'free';
    
    await db.transaction(async (tx) => {
      await tx.update(merchantSubscriptions)
        .set({ status: 'expired', scheduledDowngradeTo: null, updatedAt: now })
        .where(eq(merchantSubscriptions.id, sub.id));
      
      await tx.update(merchants)
        .set({ merchantLevel: newLevel, merchantLevelExpiresAt: null, updatedAt: now })
        .where(eq(merchants.id, sub.merchantId));
    });
    
    io.to(`merchant:${sub.merchantId}`).emit('subscription:updated', { merchantLevel: newLevel });
  }
}
```

### 5.4 é‡‘æµåˆ‡æ›è™•ç†

å•†å®¶æƒ³å¾ Stripe æ›æˆ Recurï¼ˆæˆ–åéä¾†ï¼‰ï¼š

```typescript
// ä¸æ”¯æ´è‡ªå‹•åˆ‡æ›ï¼Œç”¨æˆ¶é ˆæ‰‹å‹•æ“ä½œ
// æµç¨‹ï¼šå–æ¶ˆç¾æœ‰è¨‚é–± â†’ ç­‰åˆ°æœŸ â†’ ç”¨æ–°é‡‘æµé‡æ–°è¨‚é–±

// API: POST /api/merchant/subscription/cancel
async function cancelSubscription(merchantId: number, options: { atPeriodEnd: boolean }) {
  const subscription = await db.query.merchantSubscriptions.findFirst({
    where: eq(merchantSubscriptions.merchantId, merchantId),
  });
  
  if (!subscription) throw new Error('No active subscription');
  
  if (options.atPeriodEnd) {
    // æ¨™è¨˜ç‚ºå–æ¶ˆä¸­ï¼Œåˆ°æœŸè‡ªå‹•å¤±æ•ˆ
    await db.update(merchantSubscriptions)
      .set({ status: 'canceling', updatedAt: new Date() })
      .where(eq(merchantSubscriptions.id, subscription.id));
    
    // åœ¨ Stripe/Recur è¨­å®šåˆ°æœŸå¾Œä¸çºŒç´„
    if (subscription.provider === 'stripe') {
      await stripe.subscriptions.update(subscription.providerSubscriptionId, {
        cancel_at_period_end: true,
      });
    }
  } else {
    // ç«‹å³å–æ¶ˆ
    await db.transaction(async (tx) => {
      await tx.update(merchantSubscriptions)
        .set({ status: 'cancelled', updatedAt: new Date() })
        .where(eq(merchantSubscriptions.id, subscription.id));
      
      await tx.update(merchants)
        .set({ merchantLevel: 'free', merchantLevelExpiresAt: null })
        .where(eq(merchants.id, merchantId));
    });
  }
}
```

### 5.5 é€€æ¬¾è™•ç†

```typescript
// Admin API: POST /api/admin/subscription/refund
async function refundSubscription(subscriptionId: number, reason: string) {
  const sub = await db.query.merchantSubscriptions.findFirst({
    where: eq(merchantSubscriptions.id, subscriptionId),
  });
  
  if (!sub) throw new Error('Subscription not found');
  
  if (sub.provider === 'stripe' && sub.lastPaymentIntentId) {
    // Stripe è‡ªå‹•é€€æ¬¾
    await stripe.refunds.create({
      payment_intent: sub.lastPaymentIntentId,
      reason: 'requested_by_customer',
    });
  } else {
    // Recur é€€æ¬¾éœ€äººå·¥è™•ç†
    // è¨˜éŒ„é€€æ¬¾è«‹æ±‚ï¼Œé€šçŸ¥ç®¡ç†å“¡
    console.log(`[REFUND REQUEST] subscriptionId=${subscriptionId}, reason=${reason}`);
  }
  
  // ç«‹å³å–æ¶ˆæ¬Šé™
  await db.transaction(async (tx) => {
    await tx.update(merchants)
      .set({ merchantLevel: 'free', merchantLevelExpiresAt: null })
      .where(eq(merchants.id, sub.merchantId));
    
    await tx.update(merchantSubscriptions)
      .set({ status: 'cancelled', cancelledAt: new Date() })
      .where(eq(merchantSubscriptions.id, subscriptionId));
  });
  
  io.to(`merchant:${sub.merchantId}`).emit('subscription:updated', { merchantLevel: 'free' });
}

---

## ğŸ”— è³‡æ–™æ¨¡å‹çµ±ä¸€æ–¹æ¡ˆ

### 6.1 æœ€çµ‚æ±ºç­–

æ¡ç”¨**æ–¹æ¡ˆ A**ï¼šç›´æ¥åœ¨ `places` è¡¨æ–°å¢æ¬„ä½ï¼Œä¸é¡å¤–æ–°å¢ `merchant_place_subscriptions` è¡¨ã€‚

| è¡¨å | ç”¨é€” | ç‹€æ…‹ |
|------|------|------|
| `merchants` | å•†å®¶è³‡æ–™ + å•†å®¶ç­‰ç´šï¼ˆ`merchantLevel`ï¼‰ | **ç¾æœ‰ + æ–°å¢æ¬„ä½** |
| `merchant_place_links` | å•†å®¶èªé ˜æ™¯é»çš„é—œè¯ | **ç¾æœ‰** |
| `places` | æ™¯é»è³‡æ–™ + è¡Œç¨‹å¡ç­‰ç´šï¼ˆ`placeCardTier`ï¼‰ | **ç¾æœ‰ + æ–°å¢æ¬„ä½** |
| `merchant_subscriptions` | è¨‚é–±äº¤æ˜“ç´€éŒ„ | **æ–°å¢** |

### 6.2 é—œä¿‚è¨­è¨ˆ

```
merchants (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                      â”‚
    â”‚ merchantLevel (free/pro/premium)                     â”‚
    â”‚ merchantLevelExpiresAt                               â”‚
    â”‚ stripeCustomerId / recurCustomerId                   â”‚
    â”‚                                                      â”‚
    â†“                                                      â†“
merchant_place_links (N)                    merchant_subscriptions (N)
    â”‚ (å·²èªé ˜çš„æ™¯é»)                               â”‚ (ä»˜æ¬¾ç´€éŒ„)
    â”‚                                              â”‚
    â†“                                              â”‚
places (1)                                         â”‚
    â”‚                                              â”‚
    â”‚ merchantId â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ placeCardTier (free/pro/premium)
    â”‚ placeCardTierExpiresAt
```

### 6.3 æ¬„ä½å®šç¾©

```typescript
// shared/schema.ts - merchants è¡¨æ–°å¢æ¬„ä½
merchantLevelExpiresAt: timestamp("merchant_level_expires_at"),
stripeCustomerId: varchar("stripe_customer_id", { length: 255 }),
recurCustomerId: varchar("recur_customer_id", { length: 255 }),

// shared/schema.ts - places è¡¨æ–°å¢æ¬„ä½
placeCardTier: varchar("place_card_tier", { length: 20 }).default('free'),
placeCardTierExpiresAt: timestamp("place_card_tier_expires_at"),

// shared/schema.ts - merchant_subscriptions è¡¨ï¼ˆæ–°å¢ï¼‰
export const merchantSubscriptions = pgTable("merchant_subscriptions", {
  id: serial("id").primaryKey(),
  merchantId: integer("merchant_id").references(() => merchants.id).notNull(),
  type: varchar("type", { length: 20 }).notNull(), // 'merchant' | 'place'
  tier: varchar("tier", { length: 20 }).notNull(), // 'pro' | 'premium'
  placeId: integer("place_id").references(() => places.id), // null for merchant subscription
  provider: varchar("provider", { length: 20 }).notNull(), // 'stripe' | 'recur'
  providerSubscriptionId: varchar("provider_subscription_id", { length: 255 }).notNull(),
  providerCustomerId: varchar("provider_customer_id", { length: 255 }),
  status: varchar("status", { length: 20 }).default('active').notNull(),
  currentPeriodStart: timestamp("current_period_start"),
  currentPeriodEnd: timestamp("current_period_end"),
  scheduledDowngradeTo: varchar("scheduled_downgrade_to", { length: 20 }),
  lastPaymentIntentId: varchar("last_payment_intent_id", { length: 255 }),
  cancelledAt: timestamp("cancelled_at"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

### 6.4 å„ªé»

- æŸ¥è©¢ç°¡å–®ï¼Œä¸éœ€ JOIN
- èˆ‡ç¾æœ‰ `merchantId` æ¬„ä½é‚è¼¯ä¸€è‡´
- æ¸›å°‘è¡¨æ•¸é‡ï¼Œé™ä½ç¶­è­·æˆæœ¬

---

## ğŸ“ SEO å…§å®¹ç®¡ç†ç­–ç•¥

### 7.1 å»é‡é‚è¼¯

æ¯å€‹ **å€åŸŸ + åˆ†é¡** çµ„åˆåªç”¢ç”Ÿä¸€ç¯‡æ–‡ç« ï¼š

```sql
-- ä½¿ç”¨ COALESCE è™•ç† NULL districtï¼ˆé¿å… NULL ç¹éå”¯ä¸€ç´¢å¼•ï¼‰
CREATE UNIQUE INDEX idx_seo_itineraries_unique 
ON seo_itineraries (region_id, COALESCE(district_id, 0), category);
```

```typescript
// ç”Ÿæˆå‰æª¢æŸ¥
async function generateSeoItinerary(regionId: number, districtId: number | null, category: string) {
  const existing = await db.query.seoItineraries.findFirst({
    where: and(
      eq(seoItineraries.regionId, regionId),
      districtId ? eq(seoItineraries.districtId, districtId) : isNull(seoItineraries.districtId),
      eq(seoItineraries.category, category),
    ),
  });
  
  if (existing) {
    // æ›´æ–°ç¾æœ‰æ–‡ç« ï¼Œè€Œéæ–°å¢
    return updateSeoItinerary(existing.id, newContent);
  }
  
  // æ–°å¢æ–‡ç« 
  return createSeoItinerary({ regionId, districtId, category, ...newContent });
}
```

### 7.2 ç‰ˆæœ¬æ§åˆ¶

```typescript
// seo_itineraries è¡¨æ¬„ä½
version: integer("version").default(1).notNull(),
contentHash: varchar("content_hash", { length: 64 }), // SHA-256 of source data

// æ¯æ¬¡æ›´æ–°æ™‚éå¢ç‰ˆæœ¬è™Ÿ
await db.update(seoItineraries)
  .set({ 
    itineraryIntro: newContent,
    version: sql`version + 1`,
    contentHash: crypto.createHash('sha256').update(sourceData).digest('hex'),
    updatedAt: new Date(),
  })
  .where(eq(seoItineraries.id, id));
```

### 7.3 æ›´æ–°è§¸ç™¼æ¢ä»¶

| è§¸ç™¼æ¢ä»¶ | å‹•ä½œ | å¯¦ç¾æ–¹å¼ |
|---------|------|---------|
| æ‰‹å‹•è§¸ç™¼ï¼ˆAdminï¼‰ | é‡æ–°ç”ŸæˆæŒ‡å®šå€åŸŸçš„æ–‡ç«  | Admin API |
| æ™¯é»è³‡æ–™è®Šæ›´è¶…é 10% | æ’ç¨‹ä»»å‹™è‡ªå‹•æª¢æ¸¬ä¸¦é‡æ–°ç”Ÿæˆ | æ¯æ—¥æ’ç¨‹ |
| æ¯æœˆå®šæœŸæ›´æ–° | æ‰¹æ¬¡é‡æ–°ç”Ÿæˆæ‰€æœ‰æ–‡ç«  | æœˆåˆæ’ç¨‹ |

#### 10% è³‡æ–™è®Šæ›´é–¾å€¼è¨ˆç®—

```typescript
// server/scripts/check-seo-regeneration.ts
// æ¯æ—¥ 00:00 åŸ·è¡Œ

async function checkAndRegenerateSeoContent() {
  // 1. å–å¾—æ‰€æœ‰å·²ç™¼å¸ƒçš„ SEO æ–‡ç« 
  const seoArticles = await db.query.seoItineraries.findMany({
    where: eq(seoItineraries.status, 'published'),
  });
  
  for (const article of seoArticles) {
    // 2. è¨ˆç®—è©²å€åŸŸç•¶å‰æ™¯é»è³‡æ–™çš„ hash
    const currentPlaces = await db.query.places.findMany({
      where: and(
        eq(places.regionId, article.regionId),
        article.districtId 
          ? eq(places.districtId, article.districtId) 
          : sql`1=1`,
        eq(places.category, article.category),
        eq(places.isActive, true),
      ),
      orderBy: asc(places.id), // ç¢ºä¿é †åºä¸€è‡´
    });
    
    // 3. è¨ˆç®—è®Šæ›´æ¯”ä¾‹
    const currentHash = crypto
      .createHash('sha256')
      .update(JSON.stringify(currentPlaces.map(p => p.id)))
      .digest('hex');
    
    if (article.contentHash !== currentHash) {
      // 4. è¨ˆç®—å¯¦éš›è®Šæ›´æ¯”ä¾‹
      const originalPlaceIds = JSON.parse(article.sourcePlaceIds || '[]');
      const currentPlaceIds = currentPlaces.map(p => p.id);
      
      const added = currentPlaceIds.filter(id => !originalPlaceIds.includes(id));
      const removed = originalPlaceIds.filter(id => !currentPlaceIds.includes(id));
      
      const changeRatio = (added.length + removed.length) / Math.max(originalPlaceIds.length, 1);
      
      if (changeRatio >= 0.1) { // è¶…é 10%
        console.log(`[SEO] Regenerating article ${article.id}: ${changeRatio * 100}% changed`);
        await regenerateSeoItinerary(article.id);
      }
    }
  }
}
```

### 7.4 ç™¼å¸ƒæµç¨‹

```
AI ç”Ÿæˆ â†’ å­˜å…¥ DB (status=draft) â†’ äººå·¥å¯©æ ¸ï¼ˆå¯é¸ï¼‰â†’ ç™¼å¸ƒ (status=published) â†’ è§¸ç™¼ ISR
```

```typescript
// API: POST /api/admin/seo-itineraries/:id/publish
async function publishSeoItinerary(id: number) {
  await db.update(seoItineraries)
    .set({ status: 'published', publishedAt: new Date() })
    .where(eq(seoItineraries.id, id));
  
  // è§¸ç™¼å®˜ç¶² ISR
  const article = await db.query.seoItineraries.findFirst({
    where: eq(seoItineraries.id, id),
  });
  
  if (article) {
    await triggerIsrRevalidation(article.slug);
  }
}

async function triggerIsrRevalidation(slug: string) {
  const OFFICIAL_SITE_URL = process.env.OFFICIAL_SITE_URL;
  const SEO_SERVICE_TOKEN = process.env.SEO_SERVICE_TOKEN;
  
  await fetch(`${OFFICIAL_SITE_URL}/api/revalidate`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SEO_SERVICE_TOKEN}`,
    },
    body: JSON.stringify({ path: `/itinerary/${slug}` }),
  });
}
```

### 7.5 èˆŠæ–‡ç« è™•ç†

| æƒ…å¢ƒ | è™•ç†æ–¹å¼ | URL è™•ç† |
|------|---------|---------|
| å…§å®¹éæ™‚ | æ›´æ–° + ä¿ç•™ URL | ä¸è®Šï¼ˆSEO é€£çºŒæ€§ï¼‰ |
| å€åŸŸåœç”¨ | è¨­ç‚º archived | 301 é‡å°è‡³ä¸Šç´šé é¢ |
| é‡è¤‡å…§å®¹ | åˆä½µè‡³ä¸»æ–‡ç«  | èˆŠ URL 301 é‡å° |

```typescript
// seo_itineraries.status æ¬„ä½å€¼
type SeoStatus = 'draft' | 'published' | 'archived';
```

---

## ğŸ“… å¯¦ä½œæ­¥é©Ÿ

### Phase 1ï¼šè³‡æ–™çµæ§‹ï¼ˆå¾Œç«¯ï¼‰
1. [ ] æ–°å¢ `seo_itineraries` è³‡æ–™è¡¨
2. [ ] æ–°å¢ `merchant_subscriptions` è³‡æ–™è¡¨
3. [ ] `merchants` è¡¨æ–°å¢ 3 å€‹æ¬„ä½ï¼ˆmerchantLevelExpiresAtã€stripeCustomerIdã€recurCustomerIdï¼‰
4. [ ] `places` è¡¨æ–°å¢ 2 å€‹æ¬„ä½ï¼ˆplaceCardTierã€placeCardTierExpiresAtï¼‰
5. [ ] åŸ·è¡Œ `npm run db:push` åŒæ­¥è³‡æ–™åº«

### Phase 2ï¼šè¨‚é–± APIï¼ˆå¾Œç«¯ï¼‰
1. [ ] å¯¦ä½œå•†å®¶è¨‚é–± API ç«¯é»
2. [ ] å®Œå–„ Stripe Webhook è™•ç†ï¼ˆè¨‚é–±äº‹ä»¶ï¼‰
3. [ ] å®Œå–„ Recur Webhook è™•ç†ï¼ˆè¨‚é–±äº‹ä»¶ï¼‰
4. [ ] å»ºç«‹æ¬Šé™é™åˆ¶ Helperï¼ˆ`server/lib/merchantPermissions.ts`ï¼‰
5. [ ] å¯¦ä½œåˆ°æœŸè™•ç†æ’ç¨‹ä»»å‹™
6. [ ] å¯¦ä½œ Socket.io æ¬Šé™æ¨é€

### Phase 3ï¼šSEO API èˆ‡å…§å®¹ç”Ÿæˆï¼ˆå¾Œç«¯ï¼‰
1. [ ] å¯¦ä½œ SEO API ç«¯é»
2. [ ] ä¿®æ”¹ Gemini prompt ç”Ÿæˆ SEO å…§å®¹
3. [ ] å»ºç«‹æ‰¹æ¬¡ç”Ÿæˆè…³æœ¬ï¼ˆ`server/scripts/generate-seo-itineraries.ts`ï¼‰
4. [ ] å¯¦ä½œ ISR é‡æ–°é©—è­‰è§¸ç™¼å‡½å¼

### Phase 4ï¼šå®˜æ–¹ç¶²ç«™æ“´å……ï¼ˆå‰ç«¯ - å¦ä¸€ Replit å°ˆæ¡ˆï¼‰
1. [ ] ç¢ºèªç¾æœ‰æ¡†æ¶ä¸¦è¦åŠƒæ“´å……æ–¹å¼
2. [ ] å¯¦ä½œ SEO é é¢ï¼ˆSSG/ISR + Schema.org JSON-LDï¼‰
3. [ ] å¯¦ä½œå•†å®¶è¨‚é–±è³¼è²·é é¢ï¼ˆç”¨æˆ¶è‡ªé¸ä»˜æ¬¾æ–¹å¼ï¼‰
4. [ ] æ•´åˆ Stripe/Recur çµå¸³
5. [ ] å‹•æ…‹ sitemap.xml ç”Ÿæˆ
6. [ ] å¯¦ä½œ `/api/revalidate` è·¯ç”±ï¼ˆOn-Demand ISRï¼‰

### Phase 5ï¼šApp æ¬Šé™åŒæ­¥ï¼ˆExpo å°ˆæ¡ˆï¼‰
1. [ ] App ç«¯ç›£è½ `subscription:updated` äº‹ä»¶
2. [ ] åŠŸèƒ½æ¬Šé™æ§åˆ¶é‚è¼¯ï¼ˆå•†å®¶ç­‰ç´š + è¡Œç¨‹å¡ç­‰ç´šï¼‰
3. [ ] åˆ·æ–°å•†å®¶ session æ©Ÿåˆ¶

---

## âœ… å¾…ç”¨æˆ¶ç¢ºèªäº‹é …

1. **å®˜ç¶²æ¡†æ¶**ï¼šç¾æœ‰ Replit å®˜ç¶²å°ˆæ¡ˆä½¿ç”¨ä»€éº¼æ¡†æ¶ï¼Ÿéœ€è¦ç¢ºèªä»¥ä¾¿è¦åŠƒæ“´å……æ–¹å¼
2. **æ¬Šé™åŒæ­¥æ–¹å¼**ï¼šå»ºè­° Socket.ioï¼ˆå·²æœ‰åŸºç¤è¨­æ–½ï¼‰ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ
3. **Recur å¸³è™Ÿ**ï¼šæ˜¯å¦å·²æœ‰ Recur å•†å®¶å¸³è™Ÿèˆ‡ API Keyï¼Ÿ
4. **Stripe Price ID**ï¼šéœ€è¦åœ¨ Stripe Dashboard å»ºç«‹ä»¥ä¸‹è¨‚é–±å•†å“ï¼š
   - å•†å®¶ Proï¼ˆ$299/æœˆï¼‰
   - å•†å®¶ Premiumï¼ˆ$799/æœˆï¼‰
   - è¡Œç¨‹å¡ Proï¼ˆ$199/æœˆï¼‰
   - è¡Œç¨‹å¡ Premiumï¼ˆ$399/æœˆï¼‰
5. **SEO å…§å®¹å¯©æ ¸**ï¼šAI ç”Ÿæˆå¾Œæ˜¯å¦éœ€è¦äººå·¥å¯©æ ¸å†ç™¼å¸ƒï¼Ÿ
6. **å®˜ç¶²åŸŸå**ï¼šé è¨ˆä½¿ç”¨ mibu.tw æˆ–å…¶ä»–åŸŸåï¼Ÿ

## ğŸ”— ç³»çµ±ä¸²é€£åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ¶æ—…ç¨‹                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€SEO æµç¨‹ã€‘
Google æœå°‹ã€Œå°åŒ—ç¾é£Ÿã€
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ å®˜ç¶² SEO é é¢    â”‚ â† SSG/ISR ç”Ÿæˆ
  â”‚ /itinerary/xxx  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    ä¸‹è¼‰ Mibu App
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ App è¡Œç¨‹æ‰­è›‹    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å•†å®¶è¨‚é–±æµç¨‹ã€‘
å•†å®¶ç™»å…¥å®˜ç¶²
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ å®˜ç¶²è¨‚é–±é é¢ /merchant/subscription          â”‚
  â”‚                                              â”‚
  â”‚  é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼š                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
  â”‚  â”‚ ğŸ’³ ä¿¡ç”¨å¡   â”‚    â”‚ ğŸ¦ å°ç£åœ¨åœ° â”‚         â”‚
  â”‚  â”‚  (Stripe)   â”‚    â”‚ (Recur)     â”‚         â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        ç”¨æˆ¶è‡ªè¡Œé¸æ“‡ä»˜æ¬¾æ–¹å¼
                       â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Stripe          â”‚   æˆ–    â”‚ Recur (PAYUNi)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ å¾Œç«¯ Webhook                                 â”‚
  â”‚ POST /api/webhooks/stripe                    â”‚
  â”‚ POST /api/webhooks/recur                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ›´æ–° merchant_subscriptions                  â”‚
  â”‚ æ›´æ–° merchants.merchantLevel                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Socket.io æ¨é€ subscription:updated          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Expo App åˆ·æ–°å•†å®¶æ¬Šé™                        â”‚
  â”‚ è§£é–æ•¸æ“šåˆ†æã€æ›´å¤šè¡Œç¨‹å¡ã€æ›´å¤šå„ªæƒ åˆ¸ç­‰ç´š     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Changelog

| æ—¥æœŸ | ç‰ˆæœ¬ | è®Šæ›´å…§å®¹ |
|------|------|---------|
| 2026-01-05 | 1.1 | ä¿®æ­£ï¼šé‡‘æµç”±ç”¨æˆ¶è‡ªé¸ï¼ˆéè‡ªå‹•å°å‘ï¼‰ã€å®˜ç¶²ç‚ºç¾æœ‰ Replit å°ˆæ¡ˆ |
| 2026-01-05 | 1.0 | åˆç‰ˆè¨­è¨ˆè—åœ– |
