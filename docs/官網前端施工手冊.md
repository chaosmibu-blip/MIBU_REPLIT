# Mibu 官網前端施工手冊

> **版本**：v2.0 | **日期**：2026-01-06  
> **後端狀態**：✅ 已完成 | **前端狀態**：⏳ 待實作

---

## 目錄

1. [專案概覽](#一專案概覽)
2. [環境設定](#二環境設定)
3. [SEO 頁面實作](#三seo-頁面實作)
4. [商家功能實作](#四商家功能實作)
5. [API 完整規格](#五api-完整規格)
6. [測試清單](#六測試清單)

---

## 一、專案概覽

### 官網定位

| 受眾 | 目的 | 主要頁面 |
|------|------|---------|
| 一般旅客 | 透過 SEO 發現 Mibu → 下載 App | 城市/行政區/景點/行程 |
| 商家 | 購買訂閱方案 | 登入/定價/我的訂閱 |

### 頁面總覽

```
官網
├── SEO 頁面（公開）
│   ├── /explore                    # 城市列表
│   ├── /city/[slug]                # 城市詳情
│   ├── /city/[slug]/districts      # 行政區列表
│   ├── /district/[city]/[district] # 行政區詳情
│   ├── /place/[id]                 # 景點詳情（⚠️ 用 ID 不用 slug）
│   ├── /trips                      # 行程列表
│   └── /trip/[id]                  # 行程詳情
│
├── 商家頁面
│   ├── /for-business/pricing       # 定價頁（公開）
│   ├── /merchant/login             # 登入頁
│   ├── /merchant/subscribe         # 結帳頁（需登入）
│   └── /merchant/subscription      # 我的訂閱（需登入，唯讀）
│
└── 其他
    └── 首頁、關於我們、下載 App 等
```

---

## 二、環境設定

### Step 1: 安裝依賴

```bash
npm install @react-oauth/google react-apple-signin-auth @tanstack/react-query zustand
```

### Step 2: 環境變數 `.env.local`

```env
NEXT_PUBLIC_API_URL=https://mibu-app-mibu.replit.app
NEXT_PUBLIC_GOOGLE_CLIENT_ID=向負責人索取
NEXT_PUBLIC_APPLE_CLIENT_ID=向負責人索取
```

### Step 3: Providers 設定

```tsx
// app/providers.tsx
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient();

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      <GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID!}>
        {children}
      </GoogleOAuthProvider>
    </QueryClientProvider>
  );
}
```

---

## 三、SEO 頁面實作

### 3.1 城市列表頁 `/explore`

**API**: `GET /api/seo/cities`

```tsx
// app/explore/page.tsx
const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function ExplorePage() {
  const res = await fetch(`${API_URL}/api/seo/cities`, { next: { revalidate: 3600 } });
  const { cities } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <h1 className="text-3xl font-bold mb-8">探索城市</h1>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
        {cities.map((city: any) => (
          <a
            key={city.slug}
            href={`/city/${encodeURIComponent(city.slug)}`}
            className="block rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition"
            data-testid={`city-card-${city.slug}`}
          >
            <div className="aspect-video bg-gray-200">
              {city.imageUrl && <img src={city.imageUrl} alt={city.name} className="w-full h-full object-cover" />}
            </div>
            <div className="p-4">
              <h2 className="font-bold">{city.name}</h2>
              <p className="text-sm text-gray-500">{city.placeCount} 個景點</p>
            </div>
          </a>
        ))}
      </div>
    </main>
  );
}
```

### 3.2 城市詳情頁 `/city/[slug]`

**API**: `GET /api/seo/cities/:slug?page=1&limit=50`

> ⚠️ **必須處理分頁**

```tsx
// app/city/[slug]/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function CityPage({ params, searchParams }: { params: { slug: string }, searchParams: { page?: string } }) {
  const page = parseInt(searchParams.page || '1');
  const res = await fetch(`${API_URL}/api/seo/cities/${params.slug}?page=${page}&limit=50`);
  
  if (!res.ok) return <div>找不到該城市</div>;
  
  const { city, places, pagination } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <nav className="text-sm text-gray-500 mb-4">
        <Link href="/explore">探索</Link> → {city.name}
      </nav>
      
      <h1 className="text-3xl font-bold mb-2">{city.name}</h1>
      <p className="text-gray-600 mb-8">共 {city.placeCount} 個景點</p>
      
      <div className="mb-8">
        <Link href={`/city/${params.slug}/districts`} className="text-primary hover:underline">
          查看各行政區 →
        </Link>
      </div>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
        {places.map((place: any) => (
          <Link key={place.id} href={`/place/${place.id}`} className="block rounded-xl overflow-hidden shadow hover:shadow-lg transition" data-testid={`place-card-${place.id}`}>
            <div className="aspect-video bg-gray-200">
              {place.imageUrl && <img src={place.imageUrl} alt={place.name} className="w-full h-full object-cover" />}
            </div>
            <div className="p-4">
              <h3 className="font-bold truncate">{place.name}</h3>
              <p className="text-sm text-gray-500">{place.district}</p>
            </div>
          </Link>
        ))}
      </div>
      
      {/* 分頁 */}
      <div className="mt-8 flex justify-center gap-2">
        {pagination.hasPrev && <Link href={`/city/${params.slug}?page=${page - 1}`} className="px-4 py-2 border rounded">上一頁</Link>}
        <span className="px-4 py-2">第 {page} / {pagination.totalPages} 頁</span>
        {pagination.hasNext && <Link href={`/city/${params.slug}?page=${page + 1}`} className="px-4 py-2 border rounded">下一頁</Link>}
      </div>
      
      {/* 下載 CTA */}
      <section className="mt-16 py-12 bg-primary/10 rounded-2xl text-center">
        <h2 className="text-xl font-bold mb-4">在 Mibu App 探索更多</h2>
        <div className="flex justify-center gap-4">
          <a href="https://apps.apple.com/app/mibu" className="bg-black text-white px-6 py-3 rounded-lg">App Store</a>
          <a href="https://play.google.com/store/apps/details?id=com.mibu" className="bg-green-600 text-white px-6 py-3 rounded-lg">Google Play</a>
        </div>
      </section>
    </main>
  );
}
```

### 3.3 行政區列表頁 `/city/[slug]/districts`

**API**: `GET /api/seo/cities/:slug/districts`

```tsx
// app/city/[slug]/districts/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function DistrictsPage({ params }: { params: { slug: string } }) {
  const res = await fetch(`${API_URL}/api/seo/cities/${params.slug}/districts`);
  const { city, districts } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <nav className="text-sm text-gray-500 mb-4">
        <Link href="/explore">探索</Link> → <Link href={`/city/${params.slug}`}>{city.name}</Link> → 行政區
      </nav>
      
      <h1 className="text-3xl font-bold mb-8">{city.name} - 行政區</h1>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {districts.map((district: any) => (
          <Link key={district.slug} href={`/district/${params.slug}/${encodeURIComponent(district.slug)}`} className="p-6 bg-white rounded-xl shadow hover:shadow-lg transition text-center" data-testid={`district-card-${district.slug}`}>
            <h3 className="font-bold text-lg">{district.name}</h3>
            <p className="text-sm text-gray-500 mt-1">{district.placeCount} 個景點</p>
          </Link>
        ))}
      </div>
    </main>
  );
}
```

### 3.4 行政區詳情頁 `/district/[city]/[district]`

**API**: `GET /api/seo/districts/:citySlug/:districtSlug?page=1&limit=20`

```tsx
// app/district/[city]/[district]/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function DistrictDetailPage({ params, searchParams }: { params: { city: string; district: string }; searchParams: { page?: string } }) {
  const page = parseInt(searchParams.page || '1');
  const res = await fetch(`${API_URL}/api/seo/districts/${params.city}/${params.district}?page=${page}&limit=20`);
  
  if (!res.ok) return <div>找不到該行政區</div>;
  
  const { city, district, places, pagination } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <nav className="text-sm text-gray-500 mb-4">
        <Link href="/explore">探索</Link> → <Link href={`/city/${city.slug}`}>{city.name}</Link> → {district.name}
      </nav>
      
      <h1 className="text-3xl font-bold mb-2">{city.name} {district.name}</h1>
      <p className="text-gray-600 mb-8">共 {district.placeCount} 個景點</p>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
        {places.map((place: any) => (
          <Link key={place.id} href={`/place/${place.id}`} className="block rounded-xl overflow-hidden shadow hover:shadow-lg transition">
            <div className="aspect-video bg-gray-200">
              {place.imageUrl && <img src={place.imageUrl} alt={place.name} className="w-full h-full object-cover" />}
            </div>
            <div className="p-4">
              <h3 className="font-bold truncate">{place.name}</h3>
              <p className="text-sm text-gray-500">{place.category}</p>
            </div>
          </Link>
        ))}
      </div>
      
      {pagination.totalPages > 1 && (
        <div className="mt-8 flex justify-center gap-2">
          {pagination.hasPrev && <Link href={`/district/${params.city}/${params.district}?page=${page - 1}`} className="px-4 py-2 border rounded">上一頁</Link>}
          <span className="px-4 py-2">第 {page} / {pagination.totalPages} 頁</span>
          {pagination.hasNext && <Link href={`/district/${params.city}/${params.district}?page=${page + 1}`} className="px-4 py-2 border rounded">下一頁</Link>}
        </div>
      )}
    </main>
  );
}
```

### 3.5 景點詳情頁 `/place/[id]`

**API**: `GET /api/seo/places/by-id/:id`

> ⚠️ **必須使用 ID 路由，不要用 slug**

```tsx
// app/place/[id]/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function PlacePage({ params }: { params: { id: string } }) {
  const res = await fetch(`${API_URL}/api/seo/places/by-id/${params.id}`);
  if (!res.ok) return <div>找不到該景點</div>;
  
  const { place, relatedPlaces } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <nav className="text-sm text-gray-500 mb-4">
        <Link href="/explore">探索</Link> → <Link href={`/city/${encodeURIComponent(place.city)}`}>{place.city}</Link> → {place.name}
      </nav>
      
      <div className="aspect-video bg-gray-200 rounded-2xl overflow-hidden mb-8">
        {place.imageUrl && <img src={place.imageUrl} alt={place.name} className="w-full h-full object-cover" />}
      </div>
      
      <h1 className="text-3xl font-bold mb-2">{place.name}</h1>
      <div className="flex gap-2 text-sm text-gray-500 mb-4">
        <span>{place.city}</span><span>•</span><span>{place.district}</span><span>•</span><span>{place.category}</span>
      </div>
      
      {place.description && <p className="text-gray-700 mb-8">{place.description}</p>}
      
      {place.address && (
        <div className="mb-8">
          <h2 className="font-bold mb-2">地址</h2>
          <p className="text-gray-600">{place.address}</p>
          {place.googleMapUrl && <a href={place.googleMapUrl} target="_blank" className="text-primary hover:underline text-sm">在 Google Maps 查看 →</a>}
        </div>
      )}
      
      {relatedPlaces.length > 0 && (
        <section className="mt-12">
          <h2 className="text-xl font-bold mb-6">附近景點</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {relatedPlaces.map((p: any) => (
              <Link key={p.id} href={`/place/${p.id}`} className="block rounded-xl overflow-hidden shadow hover:shadow-lg transition">
                <div className="aspect-video bg-gray-200">{p.imageUrl && <img src={p.imageUrl} alt={p.name} className="w-full h-full object-cover" />}</div>
                <div className="p-3"><h3 className="font-bold text-sm truncate">{p.name}</h3></div>
              </Link>
            ))}
          </div>
        </section>
      )}
      
      <section className="mt-16 py-12 bg-primary/10 rounded-2xl text-center">
        <h2 className="text-xl font-bold mb-2">想把這裡加入行程？</h2>
        <p className="text-gray-600 mb-4">下載 Mibu App，輕鬆規劃你的旅程</p>
        <div className="flex justify-center gap-4">
          <a href="https://apps.apple.com/app/mibu" className="bg-black text-white px-6 py-3 rounded-lg">App Store</a>
          <a href="https://play.google.com/store/apps/details?id=com.mibu" className="bg-green-600 text-white px-6 py-3 rounded-lg">Google Play</a>
        </div>
      </section>
    </main>
  );
}
```

### 3.6 行程列表頁 `/trips`

**API**: `GET /api/seo/trips?city=xxx&page=1&limit=20`

```tsx
// app/trips/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function TripsPage({ searchParams }: { searchParams: { city?: string; page?: string } }) {
  const page = parseInt(searchParams.page || '1');
  const cityFilter = searchParams.city ? `&city=${searchParams.city}` : '';
  
  const res = await fetch(`${API_URL}/api/seo/trips?page=${page}&limit=20${cityFilter}`);
  const { trips, pagination } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <h1 className="text-3xl font-bold mb-8">精選行程</h1>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {trips.map((trip: any) => (
          <Link key={trip.id} href={`/trip/${trip.id}`} className="block rounded-xl overflow-hidden shadow hover:shadow-lg transition" data-testid={`trip-card-${trip.id}`}>
            <div className="aspect-video bg-gray-200">{trip.imageUrl && <img src={trip.imageUrl} alt={trip.title} className="w-full h-full object-cover" />}</div>
            <div className="p-4">
              <h3 className="font-bold">{trip.title}</h3>
              <p className="text-sm text-gray-500 mt-1">{trip.placeCount} 個景點</p>
              {trip.description && <p className="text-sm text-gray-600 mt-2 line-clamp-2">{trip.description}</p>}
            </div>
          </Link>
        ))}
      </div>
      
      {pagination.totalPages > 1 && (
        <div className="mt-8 flex justify-center gap-2">
          {pagination.hasPrev && <Link href={`/trips?page=${page - 1}${cityFilter}`} className="px-4 py-2 border rounded">上一頁</Link>}
          <span className="px-4 py-2">第 {page} / {pagination.totalPages} 頁</span>
          {pagination.hasNext && <Link href={`/trips?page=${page + 1}${cityFilter}`} className="px-4 py-2 border rounded">下一頁</Link>}
        </div>
      )}
    </main>
  );
}
```

### 3.7 行程詳情頁 `/trip/[id]`

**API**: `GET /api/seo/trips/:id`

```tsx
// app/trip/[id]/page.tsx
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default async function TripDetailPage({ params }: { params: { id: string } }) {
  const res = await fetch(`${API_URL}/api/seo/trips/${params.id}`);
  if (!res.ok) return <div>找不到該行程</div>;
  
  const { trip, places } = await res.json();

  return (
    <main className="container mx-auto py-12">
      <nav className="text-sm text-gray-500 mb-4"><Link href="/trips">行程</Link> → {trip.title}</nav>
      
      <h1 className="text-3xl font-bold mb-2">{trip.title}</h1>
      <p className="text-gray-500 mb-4">{trip.placeCount} 個景點</p>
      {trip.description && <p className="text-gray-700 mb-8">{trip.description}</p>}
      
      <h2 className="text-xl font-bold mb-4">行程景點</h2>
      <div className="space-y-4">
        {places.map((place: any, index: number) => (
          <div key={place.id} className="flex gap-4 p-4 bg-white rounded-xl shadow">
            <div className="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold">{index + 1}</div>
            <div className="flex-1">
              <Link href={`/place/${place.id}`} className="font-bold hover:text-primary">{place.name}</Link>
              <p className="text-sm text-gray-500">{place.category} • {place.district}</p>
              {place.description && <p className="text-sm text-gray-600 mt-1 line-clamp-2">{place.description}</p>}
            </div>
          </div>
        ))}
      </div>
      
      <section className="mt-16 py-12 bg-primary/10 rounded-2xl text-center">
        <h2 className="text-xl font-bold mb-2">喜歡這個行程？</h2>
        <p className="text-gray-600 mb-4">下載 Mibu App，一鍵收藏並開始你的旅程</p>
        <div className="flex justify-center gap-4">
          <a href="https://apps.apple.com/app/mibu" className="bg-black text-white px-6 py-3 rounded-lg">App Store</a>
          <a href="https://play.google.com/store/apps/details?id=com.mibu" className="bg-green-600 text-white px-6 py-3 rounded-lg">Google Play</a>
        </div>
      </section>
    </main>
  );
}
```

---

## 四、商家功能實作

### 4.1 功能範圍

| 功能 | 官網 | App |
|------|:----:|:---:|
| 商家註冊 | ❌ | ✅ |
| 商家登入 | ✅ | ✅ |
| 購買/升級訂閱 | ✅ | ❌ |
| 查看訂閱等級 | ✅（唯讀） | ✅ |
| 管理店家/優惠券 | ❌ | ✅ |

### 4.2 購買流程

```
定價頁 /for-business/pricing
          ↓
    點擊「購買方案」
          ↓
    已登入？
    ├─ 否 → 跳轉 /merchant/login?redirect=/merchant/subscribe?plan=pro
    │         ↓
    │     OAuth 登入
    │         ↓
    │     後端驗證帳號
    │         ├─ 帳號不存在 → 顯示「請下載 App 註冊」
    │         └─ 商家帳號 → 登入成功 → 跳回購買頁
    │
    └─ 是 → 直接進入 Stripe/Recur 結帳
              ↓
          完成支付 → 跳轉 /merchant/subscription
```

### 4.3 Hooks

#### `hooks/useAuth.ts`

```typescript
'use client';

import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  email: string;
  name: string;
  role: string;
}

interface AuthState {
  token: string | null;
  user: User | null;
  isLoggedIn: boolean;
  login: (token: string, user: User) => void;
  logout: () => void;
}

export const useAuth = create<AuthState>()(
  persist(
    (set) => ({
      token: null,
      user: null,
      isLoggedIn: false,
      login: (token, user) => set({ token, user, isLoggedIn: true }),
      logout: () => set({ token: null, user: null, isLoggedIn: false }),
    }),
    { name: 'merchant-auth' }
  )
);
```

#### `hooks/useSubscriptionPlans.ts`

```typescript
import { useQuery } from '@tanstack/react-query';

export interface SubscriptionPlan {
  tier: string;
  name: string;
  priceMonthly: number;
  features: string[];
  highlighted: boolean;
  maxPlaces: number;
  maxCoupons: number;
}

export function useSubscriptionPlans() {
  return useQuery({
    queryKey: ['subscription-plans'],
    queryFn: async () => {
      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/subscription-plans`);
      if (!res.ok) throw new Error('Failed to fetch plans');
      const data = await res.json();
      return data.plans as SubscriptionPlan[];
    },
    staleTime: 5 * 60 * 1000,
  });
}
```

### 4.4 Components

#### `components/auth/AuthGuard.tsx`

```tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { useRouter, usePathname } from 'next/navigation';
import { useEffect } from 'react';

export function AuthGuard({ children }: { children: React.ReactNode }) {
  const { isLoggedIn } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  useEffect(() => {
    if (!isLoggedIn) {
      router.push(`/merchant/login?redirect=${encodeURIComponent(pathname)}`);
    }
  }, [isLoggedIn, pathname, router]);

  if (!isLoggedIn) {
    return <div className="min-h-screen flex items-center justify-center"><div className="text-gray-500">正在跳轉到登入頁...</div></div>;
  }

  return <>{children}</>;
}
```

#### `components/auth/SocialLoginButtons.tsx`

```tsx
'use client';

import { GoogleLogin } from '@react-oauth/google';
import AppleSignin from 'react-apple-signin-auth';
import { useRouter, useSearchParams } from 'next/navigation';
import { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export function SocialLoginButtons() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { login } = useAuth();
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const redirectTo = searchParams.get('redirect') || '/merchant/subscription';

  const handleGoogleSuccess = async (credentialResponse: any) => {
    setLoading(true);
    setError(null);
    
    try {
      const res = await fetch(`${API_URL}/api/auth/google`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken: credentialResponse.credential, targetPortal: 'merchant' }),
      });
      
      const data = await res.json();
      
      if (!data.success) {
        if (data.code === 'OAUTH_NEW_USER_TRAVELER_ONLY') {
          setError('此帳號尚未註冊為商家，請先下載 Mibu App 完成商家註冊');
        } else if (data.code === 'ROLE_MISMATCH') {
          setError('此帳號不是商家帳號，無法在此登入');
        } else {
          setError(data.error || '登入失敗');
        }
        return;
      }
      
      login(data.token, data.user);
      router.push(redirectTo);
    } catch (err) {
      setError('網路錯誤，請稍後再試');
    } finally {
      setLoading(false);
    }
  };

  const handleAppleSuccess = async (response: any) => {
    setLoading(true);
    setError(null);
    
    try {
      const res = await fetch(`${API_URL}/api/auth/apple`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identityToken: response.authorization.id_token, user: response.user?.email, fullName: response.user, targetPortal: 'merchant' }),
      });
      
      const data = await res.json();
      
      if (!data.success) {
        if (data.code === 'OAUTH_NEW_USER_TRAVELER_ONLY') {
          setError('此帳號尚未註冊為商家，請先下載 Mibu App 完成商家註冊');
        } else if (data.code === 'ROLE_MISMATCH') {
          setError('此帳號不是商家帳號，無法在此登入');
        } else {
          setError(data.error || '登入失敗');
        }
        return;
      }
      
      login(data.token, data.user);
      router.push(redirectTo);
    } catch (err) {
      setError('網路錯誤，請稍後再試');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4" data-testid="social-login-buttons">
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4" data-testid="login-error">
          <p className="text-red-600 text-sm">{error}</p>
          {error.includes('下載') && (
            <div className="mt-3 flex gap-2">
              <a href="https://apps.apple.com/app/mibu" className="text-xs bg-black text-white px-3 py-1.5 rounded">App Store</a>
              <a href="https://play.google.com/store/apps/details?id=com.mibu" className="text-xs bg-green-600 text-white px-3 py-1.5 rounded">Google Play</a>
            </div>
          )}
        </div>
      )}
      
      <div className="w-full" data-testid="google-login-wrapper">
        <GoogleLogin onSuccess={handleGoogleSuccess} onError={() => setError('Google 登入失敗')} text="signin_with" shape="rectangular" width="100%" locale="zh_TW" />
      </div>
      
      <AppleSignin
        authOptions={{ clientId: process.env.NEXT_PUBLIC_APPLE_CLIENT_ID!, scope: 'email name', redirectURI: `${typeof window !== 'undefined' ? window.location.origin : ''}/api/auth/apple/callback`, usePopup: true }}
        onSuccess={handleAppleSuccess}
        onError={() => setError('Apple 登入失敗')}
        render={(props) => (
          <button {...props} disabled={loading} className="w-full flex items-center justify-center gap-2 bg-black text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition disabled:opacity-50" data-testid="apple-login-button">
            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
            使用 Apple 登入
          </button>
        )}
      />
      
      {loading && <div className="text-center text-gray-500 text-sm">登入中...</div>}
    </div>
  );
}
```

### 4.5 Pages

#### `/merchant/login/page.tsx`

```tsx
import { SocialLoginButtons } from '@/components/auth/SocialLoginButtons';

export const metadata = { title: '商家登入 | Mibu', description: '登入 Mibu 商家帳號，購買或查看您的訂閱方案' };

export default function MerchantLoginPage() {
  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
      <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-gray-900" data-testid="login-title">商家登入</h1>
          <p className="mt-2 text-sm text-gray-600">登入後可購買或查看訂閱方案</p>
        </div>
        
        <SocialLoginButtons />
        
        <div className="mt-8 pt-6 border-t text-center">
          <p className="text-sm text-gray-500">還沒有商家帳號？</p>
          <p className="text-sm text-gray-600 mt-1">請下載 <span className="font-semibold text-primary">Mibu App</span> 完成商家註冊</p>
          <div className="mt-4 flex justify-center gap-3">
            <a href="https://apps.apple.com/app/mibu" className="inline-flex items-center px-4 py-2 bg-black text-white rounded-lg text-sm" data-testid="download-ios">App Store</a>
            <a href="https://play.google.com/store/apps/details?id=com.mibu" className="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm" data-testid="download-android">Google Play</a>
          </div>
        </div>
      </div>
    </main>
  );
}
```

#### `/for-business/pricing/page.tsx`

```tsx
'use client';

import { useSubscriptionPlans } from '@/hooks/useSubscriptionPlans';
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';

export default function PricingPage() {
  const { data: plans, isLoading, error, refetch } = useSubscriptionPlans();
  const { isLoggedIn } = useAuth();
  const router = useRouter();

  const handleSelectPlan = (tier: string) => {
    if (tier === 'free') {
      router.push(isLoggedIn ? '/merchant/subscription' : '/merchant/login');
      return;
    }
    if (isLoggedIn) {
      router.push(`/merchant/subscribe?plan=${tier}`);
    } else {
      router.push(`/merchant/login?redirect=${encodeURIComponent(`/merchant/subscribe?plan=${tier}`)}`);
    }
  };

  if (isLoading) return <div className="py-16 text-center">載入中...</div>;
  if (error) return <div className="py-16 text-center text-red-500">載入失敗 <button onClick={() => refetch()} className="underline">重試</button></div>;

  return (
    <main className="py-16 px-4 bg-gray-50 min-h-screen">
      <div className="max-w-5xl mx-auto">
        <div className="text-center mb-12">
          <h1 className="text-3xl font-bold text-gray-900" data-testid="pricing-title">選擇適合您的方案</h1>
          <p className="mt-3 text-gray-600">從免費開始，隨時升級解鎖更多功能</p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
          {plans?.map((plan) => (
            <div key={plan.tier} className={`bg-white rounded-2xl shadow-lg p-6 ${plan.highlighted ? 'ring-2 ring-primary' : ''}`}>
              <h3 className="text-xl font-bold">{plan.name}</h3>
              <p className="text-3xl font-bold mt-4">NT${plan.priceMonthly}<span className="text-sm text-gray-500">/月</span></p>
              <ul className="mt-6 space-y-2">
                {plan.features.map((f, i) => <li key={i} className="text-sm text-gray-600">✓ {f}</li>)}
              </ul>
              <button onClick={() => handleSelectPlan(plan.tier)} className="w-full mt-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition">
                {plan.tier === 'free' ? '開始使用' : '選擇方案'}
              </button>
            </div>
          ))}
        </div>
      </div>
    </main>
  );
}
```

#### `/merchant/subscription/page.tsx`

```tsx
'use client';

import { AuthGuard } from '@/components/auth/AuthGuard';
import { useAuth } from '@/hooks/useAuth';
import { useQuery } from '@tanstack/react-query';
import Link from 'next/link';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

function SubscriptionContent() {
  const { token, user, logout } = useAuth();

  const { data, isLoading } = useQuery({
    queryKey: ['merchant-subscription'],
    queryFn: async () => {
      const res = await fetch(`${API_URL}/api/merchant`, { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) throw new Error('Failed to fetch');
      return res.json();
    },
  });

  const merchant = data?.merchant;
  const tierLabels: Record<string, string> = { free: '免費方案', pro: '專業方案', premium: '旗艦方案' };

  return (
    <main className="min-h-screen bg-gray-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl shadow-lg p-8">
          <div className="flex justify-between items-start mb-8">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">我的訂閱</h1>
              <p className="text-gray-500 mt-1">{user?.email}</p>
            </div>
            <button onClick={logout} className="text-sm text-gray-500 hover:text-gray-700">登出</button>
          </div>

          {isLoading ? (
            <div className="animate-pulse space-y-4"><div className="h-8 bg-gray-200 rounded w-1/3" /><div className="h-4 bg-gray-200 rounded w-1/2" /></div>
          ) : merchant ? (
            <div className="space-y-6">
              <div className="p-6 bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl">
                <p className="text-sm text-gray-600">目前方案</p>
                <p className="text-2xl font-bold text-primary mt-1">{tierLabels[merchant.merchantLevel] || merchant.merchantLevel}</p>
                {merchant.merchantLevelExpiresAt && <p className="text-sm text-gray-500 mt-2">到期日：{new Date(merchant.merchantLevelExpiresAt).toLocaleDateString('zh-TW')}</p>}
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-gray-50 rounded-lg"><p className="text-sm text-gray-500">可管理店家數</p><p className="text-xl font-bold">{merchant.maxPlaces || '無限制'}</p></div>
                <div className="p-4 bg-gray-50 rounded-lg"><p className="text-sm text-gray-500">可發放優惠券數</p><p className="text-xl font-bold">{merchant.maxCoupons || '無限制'}</p></div>
              </div>

              {merchant.merchantLevel === 'free' && <Link href="/for-business/pricing" className="block w-full text-center bg-primary text-white py-3 rounded-lg font-medium hover:bg-primary-dark transition">升級方案</Link>}

              <div className="pt-6 border-t text-center text-sm text-gray-500"><p>如需管理店家或優惠券，請使用 Mibu App</p></div>
            </div>
          ) : (
            <div className="text-center py-8 text-gray-500">找不到商家資料</div>
          )}
        </div>
      </div>
    </main>
  );
}

export default function SubscriptionPage() {
  return <AuthGuard><SubscriptionContent /></AuthGuard>;
}
```

---

## 五、API 完整規格

### 5.1 SEO API（公開）

| 端點 | 說明 | 分頁 |
|------|------|:----:|
| `GET /api/seo/cities` | 城市列表 | ❌ |
| `GET /api/seo/cities/:slug?page=1&limit=50` | 城市詳情 + 景點 | ✅ |
| `GET /api/seo/cities/:slug/districts` | 行政區列表 | ❌ |
| `GET /api/seo/districts/:city/:district?page=1&limit=20` | 行政區詳情 | ✅ |
| `GET /api/seo/places/by-id/:id` | 景點詳情（推薦） | ❌ |
| `GET /api/seo/places?city=xxx` | 景點搜尋/篩選 | ✅ |
| `GET /api/seo/trips?city=xxx` | 行程列表 | ✅ |
| `GET /api/seo/trips/:id` | 行程詳情 | ❌ |

### 5.2 商家 API

| 端點 | 說明 | 認證 |
|------|------|:----:|
| `GET /api/subscription-plans` | 訂閱方案列表 | ❌ |
| `POST /api/auth/google` | Google 登入 | ❌ |
| `POST /api/auth/apple` | Apple 登入 | ❌ |
| `GET /api/merchant` | 取得商家資料 | ✅ |

### 5.3 登入 API 請求/回應

```typescript
// POST /api/auth/google
Request: { idToken: string, targetPortal: 'merchant' }

// 成功
Response: { success: true, token: string, user: { id, email, name, role } }

// 失敗 - 帳號不存在
Response: { success: false, code: 'OAUTH_NEW_USER_TRAVELER_ONLY', error: '...' }

// 失敗 - 不是商家帳號
Response: { success: false, code: 'ROLE_MISMATCH', error: '...' }
```

---

## 六、測試清單

### SEO 頁面
- [ ] `/explore` 顯示城市列表（22 個城市）
- [ ] `/city/台北市` 顯示景點（2504 筆，分頁正確）
- [ ] `/city/台北市/districts` 顯示行政區（14 個）
- [ ] `/district/台北市/萬華區` 顯示景點
- [ ] `/place/3406` 顯示西門町詳情
- [ ] `/trips` 顯示行程列表
- [ ] `/trip/1` 顯示行程詳情
- [ ] 所有頁面底部有下載 App CTA

### 商家功能
- [ ] `/for-business/pricing` 顯示 3 個方案
- [ ] 未登入點擊「購買」→ 跳轉登入頁（redirect 參數正確）
- [ ] Google 登入成功 → 跳回購買頁
- [ ] 帳號不存在 → 顯示「請下載 App 註冊」+ 下載按鈕
- [ ] `/merchant/subscription` 顯示目前方案（唯讀）
- [ ] 登出按鈕正常運作

### cURL 測試

```bash
# 城市列表
curl "https://mibu-app-mibu.replit.app/api/seo/cities"

# 城市詳情
curl "https://mibu-app-mibu.replit.app/api/seo/cities/台北市?page=1&limit=10"

# 行政區列表
curl "https://mibu-app-mibu.replit.app/api/seo/cities/台北市/districts"

# 景點詳情
curl "https://mibu-app-mibu.replit.app/api/seo/places/by-id/3406"

# 訂閱方案
curl "https://mibu-app-mibu.replit.app/api/subscription-plans"
```

---

## 關鍵原則

1. **景點詳情必須用 ID** → `/place/[id]`，不要用 slug
2. **分頁必須處理** → 城市/行政區景點列表都有分頁
3. **官網商家極簡** → 只有登入 + 購買 + 查看等級
4. **商家註冊在 App** → 官網登入是驗證帳號是否存在
5. **每頁都要 CTA** → 引導下載 App
