# ç”¨æˆ¶è²¢ç»ç³»çµ±è¨˜æ†¶åº« (Contribution System)

## æ¨¡çµ„ç¯„åœ

ç”¨æˆ¶å”åŠ©ç¶­è­·æ™¯é»è³‡æ–™å“è³ªï¼šå›å ±æ­‡æ¥­ã€å»ºè­°æ™¯é»ã€æ’é™¤ä½å“è³ªæ™¯é»ã€‚

---

## è²¢ç»é¡å‹

| é¡å‹ | èªªæ˜ | çå‹µ |
|------|------|------|
| å›å ±æ­‡æ¥­ | å›å ±æ™¯é»å·²é—œé–‰/æ¬é· | ç¶“é©—å€¼ |
| å»ºè­°æ™¯é» | å»ºè­°æ–°å¢æ™¯é»åˆ°ç³»çµ± | ç¶“é©—å€¼ |
| æ’é™¤æŠ•ç¥¨ | æ¨™è¨˜é»‘åå–® + åƒèˆ‡æŠ•ç¥¨ | ç¶“é©—å€¼ |

---

## å›å ±æ­‡æ¥­

### æµç¨‹

```
ç”¨æˆ¶ç™¼ç¾æ™¯é»å·²æ­‡æ¥­
         â”‚
         â–¼
é»æ“Šã€Œå›å ±æ­‡æ¥­ã€æŒ‰éˆ•
         â”‚
         â–¼
é¸æ“‡åŸå› ï¼š
â”œâ”€â”€ å·²æ°¸ä¹…é—œé–‰
â”œâ”€â”€ æš«æ™‚æ­‡æ¥­
â”œâ”€â”€ å·²æ¬é·
â””â”€â”€ è³‡è¨ŠéŒ¯èª¤
         â”‚
         â–¼
å¯é¸ï¼šè£œå……èªªæ˜
         â”‚
         â–¼
æäº¤å›å ±
         â”‚
         â–¼
é€²å…¥å¯©æ ¸æµç¨‹
```

### å¯©æ ¸æµç¨‹

```
å›å ±æäº¤
    â”‚
    â–¼
AI é å¯©
â”œâ”€â”€ æª¢æŸ¥æ˜¯å¦å¤šäººå›å ±åŒä¸€æ™¯é»
â”œâ”€â”€ äº¤å‰æ¯”å° Google Places API ç‹€æ…‹
â””â”€â”€ åˆ¤æ–·å¯ä¿¡åº¦
    â”‚
    â”œâ”€â”€ é«˜å¯ä¿¡åº¦ â†’ è‡ªå‹•é€šé
    â”œâ”€â”€ ä¸­å¯ä¿¡åº¦ â†’ ç¤¾ç¾¤æŠ•ç¥¨
    â””â”€â”€ ä½å¯ä¿¡åº¦ â†’ äººå·¥å¯©æ ¸
    â”‚
    â–¼
å¯©æ ¸é€šé â†’ æ™¯é»æ¨™è¨˜ç‚ºæ­‡æ¥­ï¼ˆè»Ÿåˆªé™¤ï¼‰
    â”‚
    â–¼
ç”¨æˆ¶ç²å¾—ç¶“é©—å€¼
```

### çå‹µ

| çµæœ | ç¶“é©—å€¼ |
|------|--------|
| å›å ±é€šé | 40 |
| æ¯æ—¥ä¸Šé™ | 90ï¼ˆç´„ 2-3 æ¬¡ï¼‰|

---

## å»ºè­°æ™¯é»

### æµç¨‹

```
ç”¨æˆ¶ç™¼ç¾å¥½æ™¯é»ä¸åœ¨ç³»çµ±ä¸­
         â”‚
         â–¼
é»æ“Šã€Œå»ºè­°æ™¯é»ã€
         â”‚
         â–¼
å¡«å¯«è³‡è¨Šï¼š
â”œâ”€â”€ æ™¯é»åç¨±ï¼ˆå¿…å¡«ï¼‰
â”œâ”€â”€ åœ°å€/ä½ç½®ï¼ˆå¿…å¡«ï¼‰
â”œâ”€â”€ åˆ†é¡ï¼ˆå¿…å¡«ï¼‰
â”œâ”€â”€ æè¿°ï¼ˆé¸å¡«ï¼‰
â””â”€â”€ Google Maps é€£çµï¼ˆé¸å¡«ï¼‰
         â”‚
         â–¼
æäº¤å»ºè­°
         â”‚
         â–¼
é€²å…¥å¯©æ ¸æµç¨‹
```

### å¯©æ ¸æµç¨‹

```
å»ºè­°æäº¤
    â”‚
    â–¼
AI é å¯©
â”œâ”€â”€ æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
â”œâ”€â”€ æª¢æŸ¥æ˜¯å¦ç¬¦åˆä¸ƒå¤§åˆ†é¡
â”œâ”€â”€ æª¢æŸ¥æ˜¯å¦ç‚ºåˆæ³•å•†æ¥­/æ™¯é»
â””â”€â”€ åˆ¤æ–·å“è³ª
    â”‚
    â”œâ”€â”€ é«˜å“è³ª â†’ é€²å…¥ç¤¾ç¾¤æŠ•ç¥¨
    â”œâ”€â”€ ä¸­å“è³ª â†’ äººå·¥å¯©æ ¸
    â””â”€â”€ ä½å“è³ª/åƒåœ¾ â†’ æ‹’çµ•
    â”‚
    â–¼
ç¤¾ç¾¤æŠ•ç¥¨ï¼ˆ3 ç¥¨é€šé / 3 ç¥¨å¦æ±º / 72hr è¶…æ™‚ï¼‰
    â”‚
    â”œâ”€â”€ é€šé â†’ é€²å…¥ place_drafts
    â”œâ”€â”€ å¦æ±º â†’ æ‹’çµ• + é€šçŸ¥ç”¨æˆ¶
    â””â”€â”€ è¶…æ™‚ â†’ äººå·¥å¯©æ ¸
    â”‚
    â–¼
place_drafts â†’ AI è£œå……æè¿° â†’ places
    â”‚
    â–¼
ç”¨æˆ¶ç²å¾—ç¶“é©—å€¼
```

### çå‹µ

| çµæœ | ç¶“é©—å€¼ |
|------|--------|
| å»ºè­°æ¡ç´ | 120 |
| æ¯æ—¥ä¸Šé™ | 240ï¼ˆç´„ 2 æ¬¡ï¼‰|

---

## é»‘åå–®æ’é™¤æ©Ÿåˆ¶

### ç”¨æˆ¶æ¨™è¨˜

```
ç”¨æˆ¶æŠ½åˆ°ä¸å–œæ­¡çš„æ™¯é»
         â”‚
         â–¼
é»æ“Šã€ŒåŠ å…¥é»‘åå–®ã€ğŸš«
         â”‚
         â–¼
ç³»çµ±è¨˜éŒ„ï¼š
â”œâ”€â”€ ç”¨æˆ¶å€‹äººé»‘åå–®ï¼ˆè©²ç”¨æˆ¶ä¸å†æŠ½åˆ°ï¼‰
â””â”€â”€ å…¨åŸŸçµ±è¨ˆï¼ˆç´¯è¨ˆå¤šå°‘äººæ¨™è¨˜ï¼‰
```

### å…¨åŸŸæ’é™¤è¦å‰‡

| é–€æª» | æ•ˆæœ |
|------|------|
| 50 äºº/æœˆ æ¨™è¨˜ | é™ä½è©²æ™¯é»æŠ½å–æ¬Šé‡ (Ã—0.3) |
| 100 äºº/æœˆ æ¨™è¨˜ | è»Ÿåˆªé™¤ï¼ˆisActive = falseï¼‰|

### çµ±è¨ˆé‡ç½®

- æ¯æœˆ 1 æ—¥é‡ç½®ç•¶æœˆçµ±è¨ˆ
- å·²è»Ÿåˆªé™¤çš„æ™¯é»ä¸æœƒè‡ªå‹•æ¢å¾©
- å¯ç”± Admin æ‰‹å‹•æ¢å¾©

### æ’é™¤æŠ•ç¥¨

ç”¨æˆ¶å¯ä»¥åƒèˆ‡ã€Œæ˜¯å¦æ’é™¤æŸæ™¯é»ã€çš„æŠ•ç¥¨ï¼š

```
æ™¯é»é”åˆ° 30 äººæ¨™è¨˜
         â”‚
         â–¼
é€²å…¥ã€Œå¾…æŠ•ç¥¨ã€ç‹€æ…‹
         â”‚
         â–¼
å…¶ä»–ç”¨æˆ¶å¯æŠ•ç¥¨ï¼š
â”œâ”€â”€ ã€Œæ‡‰è©²æ’é™¤ã€
â””â”€â”€ ã€Œä¸æ‡‰æ’é™¤ã€
         â”‚
         â–¼
72hr å…§ï¼š
â”œâ”€â”€ æ’é™¤ç¥¨ â‰¥ 20 â†’ æå‰è»Ÿåˆªé™¤
â”œâ”€â”€ ä¸æ’é™¤ç¥¨ â‰¥ 20 â†’ å–æ¶ˆå¾…æŠ•ç¥¨ç‹€æ…‹
â””â”€â”€ æœªé”é–€æª» â†’ ç¹¼çºŒç´¯è¨ˆ
```

### çå‹µ

| è¡Œç‚º | ç¶“é©—å€¼ |
|------|--------|
| åƒèˆ‡æ’é™¤æŠ•ç¥¨ | 5 |
| æ¯æ—¥ä¸Šé™ | 25ï¼ˆç´„ 5 æ¬¡ï¼‰|

---

## å¯©æ ¸æ©Ÿåˆ¶ç¸½è¦½

### ä¸‰å±¤å¯©æ ¸

```
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  ç”¨æˆ¶æäº¤   â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  AI é å¯©    â”‚ â† Gemini åˆ¤æ–·
      â”‚  (Layer 1)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼        â–¼        â–¼
 è‡ªå‹•é€šé  ç¤¾ç¾¤æŠ•ç¥¨   äººå·¥å¯©æ ¸
           (Layer 2) (Layer 3)
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  æœ€çµ‚çµæœ   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AI é å¯©ï¼ˆLayer 1ï¼‰

| æª¢æŸ¥é …ç›® | èªªæ˜ |
|----------|------|
| é‡è¤‡æª¢æŸ¥ | æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ™¯é»/å›å ± |
| åˆ†é¡æª¢æŸ¥ | æ˜¯å¦ç¬¦åˆä¸ƒå¤§åˆ†é¡ |
| å“è³ªæª¢æŸ¥ | æ˜¯å¦ç‚ºåƒåœ¾/å»£å‘Š/ä¸ç•¶å…§å®¹ |
| å¯ä¿¡åº¦ | ç¶œåˆåˆ¤æ–·é€šéæ©Ÿç‡ |

### ç¤¾ç¾¤æŠ•ç¥¨ï¼ˆLayer 2ï¼‰

| åƒæ•¸ | å€¼ |
|------|-----|
| é€šéé–€æª» | 3 ç¥¨åŒæ„ |
| å¦æ±ºé–€æª» | 3 ç¥¨åå° |
| è¶…æ™‚æ™‚é–“ | 72 å°æ™‚ |
| æŠ•ç¥¨è³‡æ ¼ | Lv.7+ ç”¨æˆ¶ |

### äººå·¥å¯©æ ¸ï¼ˆLayer 3ï¼‰

- åƒ…è™•ç†çˆ­è­°æ¡ˆä¾‹
- Admin å¾Œå°æ“ä½œ
- æœ€çµ‚æ±ºå®šæ¬Š

---

## æˆå°±é€£å‹•

| æˆå°± | æ¢ä»¶ | çå‹µ |
|------|------|------|
| å“è³ªå®ˆè­·è€… | å›å ± 10 æ¬¡é€šé | ã€Œå®ˆè­·è€…ã€å¾½ç«  |
| æ™¯é»æ¢éšªå®¶ | å»ºè­° 3 æ™¯é»æ¡ç´ | ã€Œæ¢éšªå®¶ã€é ­æ¡† |
| æ­£ç¾©ä½¿è€… | åƒèˆ‡ 50 æ¬¡æ’é™¤æŠ•ç¥¨ | ã€Œæ­£ç¾©ã€ç‰¹æ•ˆ |

---

## API è¨­è¨ˆ

### å›å ±æ­‡æ¥­

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/contribution/report-closed` | å›å ±æ­‡æ¥­ |
| GET | `/api/contribution/my-reports` | æˆ‘çš„å›å ±è¨˜éŒ„ |

### å»ºè­°æ™¯é»

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/contribution/suggest-place` | å»ºè­°æ™¯é» |
| GET | `/api/contribution/my-suggestions` | æˆ‘çš„å»ºè­°è¨˜éŒ„ |

### é»‘åå–®

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/collection/:placeId/blacklist` | åŠ å…¥é»‘åå–® |
| DELETE | `/api/collection/:placeId/blacklist` | ç§»é™¤é»‘åå–® |
| GET | `/api/collection/blacklist` | æˆ‘çš„é»‘åå–® |

### æ’é™¤æŠ•ç¥¨

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/contribution/pending-votes` | å¾…æŠ•ç¥¨æ™¯é»åˆ—è¡¨ |
| POST | `/api/contribution/vote/:placeId` | æŠ•ç¥¨ï¼ˆæ’é™¤/ä¸æ’é™¤ï¼‰|

### ç¤¾ç¾¤æŠ•ç¥¨ï¼ˆå»ºè­°æ™¯é»ï¼‰

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/contribution/pending-suggestions` | å¾…æŠ•ç¥¨å»ºè­°åˆ—è¡¨ |
| POST | `/api/contribution/vote-suggestion/:id` | æŠ•ç¥¨ï¼ˆé€šé/å¦æ±ºï¼‰|

### ç®¡ç†ï¼ˆAdminï¼‰

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/admin/contribution/reports` | å›å ±å¯©æ ¸åˆ—è¡¨ |
| PATCH | `/api/admin/contribution/reports/:id` | å¯©æ ¸å›å ± |
| GET | `/api/admin/contribution/suggestions` | å»ºè­°å¯©æ ¸åˆ—è¡¨ |
| PATCH | `/api/admin/contribution/suggestions/:id` | å¯©æ ¸å»ºè­° |
| GET | `/api/admin/contribution/blacklist-stats` | é»‘åå–®çµ±è¨ˆ |
| POST | `/api/admin/contribution/restore-place/:id` | æ¢å¾©è»Ÿåˆªé™¤æ™¯é» |

---

## è³‡æ–™è¡¨è¨­è¨ˆ

```typescript
// æ­‡æ¥­å›å ±
placeReports {
  id: serial PK,
  placeId: number FK,
  userId: string FK,
  reason: 'permanently_closed' | 'temporarily_closed' | 'relocated' | 'info_error',
  description: string | null,
  status: 'pending' | 'approved' | 'rejected',
  aiScore: number | null,     // AI å¯ä¿¡åº¦åˆ†æ•¸
  reviewedBy: string | null,
  reviewedAt: timestamp | null,
  rewardPaid: boolean,
  createdAt: timestamp
}

// æ™¯é»å»ºè­°
placeSuggestions {
  id: serial PK,
  userId: string FK,
  placeName: string,
  address: string,
  city: string,
  country: string,
  category: string,
  description: string | null,
  googleMapsUrl: string | null,
  status: 'pending_ai' | 'pending_vote' | 'pending_review' | 'approved' | 'rejected',
  aiScore: number | null,
  voteApprove: number default 0,
  voteReject: number default 0,
  voteDeadline: timestamp | null,
  reviewedBy: string | null,
  reviewedAt: timestamp | null,
  linkedPlaceId: number | null, // æ¡ç´å¾Œé—œè¯çš„ place ID
  rewardPaid: boolean,
  createdAt: timestamp
}

// å»ºè­°æŠ•ç¥¨è¨˜éŒ„
suggestionVotes {
  id: serial PK,
  suggestionId: number FK,
  userId: string FK,
  vote: 'approve' | 'reject',
  createdAt: timestamp
}
// UNIQUE: (suggestionId, oduserId)

// ç”¨æˆ¶é»‘åå–®
userPlaceBlacklists {
  id: serial PK,
  userId: string FK,
  placeId: number FK,
  createdAt: timestamp
}
// UNIQUE: (userId, placeId)

// æ™¯é»é»‘åå–®çµ±è¨ˆï¼ˆå…¨åŸŸï¼‰
placeDislikeStats {
  placeId: number PK,
  monthlyDislikeCount: number default 0,
  totalDislikeCount: number default 0,
  lastResetAt: timestamp,
  status: 'normal' | 'reduced' | 'pending_vote' | 'excluded',
  updatedAt: timestamp
}

// æ’é™¤æŠ•ç¥¨è¨˜éŒ„
placeExclusionVotes {
  id: serial PK,
  placeId: number FK,
  userId: string FK,
  vote: 'exclude' | 'keep',
  createdAt: timestamp
}
// UNIQUE: (placeId, userId)

// ç”¨æˆ¶æ¯æ—¥è²¢ç»çµ±è¨ˆï¼ˆç”¨æ–¼é™é¡ï¼‰
userDailyContributions {
  id: serial PK,
  userId: string,
  date: date,
  reportCount: number default 0,
  suggestionCount: number default 0,
  voteCount: number default 0,
  createdAt: timestamp
}
// UNIQUE: (userId, date)
```

---

## æŠ½å¡æ™‚çš„æ¬Šé‡èª¿æ•´

```typescript
// åœ¨ gacha-v3.ts ä¸­

async function getPlaceWeight(placeId: number, userId: string): Promise<number> {
  // 1. æª¢æŸ¥ç”¨æˆ¶å€‹äººé»‘åå–®
  const isBlacklisted = await checkUserBlacklist(userId, placeId);
  if (isBlacklisted) return 0; // å®Œå…¨æ’é™¤

  // 2. æª¢æŸ¥å…¨åŸŸç‹€æ…‹
  const stats = await getPlaceDislikeStats(placeId);

  if (stats.status === 'excluded') return 0;
  if (stats.status === 'reduced') return 0.3; // é™ä½ 70%

  return 1; // æ­£å¸¸æ¬Šé‡
}
```

---

## èˆ‡å…¶ä»–æ¨¡çµ„çš„é—œè¯

- **ç¶“æ¿Ÿç³»çµ±**: è²¢ç»é€šé â†’ è§¸ç™¼ç¶“é©—å€¼
- **æˆå°±ç³»çµ±**: è²¢ç»è€…æˆå°±ç·š
- **æ‰­è›‹æ¨¡çµ„**: é»‘åå–®å½±éŸ¿æŠ½å–æ¬Šé‡
- **æ™¯é»æ¨¡çµ„**: å›å ± â†’ è»Ÿåˆªé™¤ã€å»ºè­° â†’ place_drafts

---

## é–‹ç™¼ç‹€æ…‹

### å·²å®Œæˆ
- [x] æ­‡æ¥­å›å ±è³‡æ–™è¡¨ï¼ˆ`place_reports`ï¼‰
- [x] æ™¯é»å»ºè­°è³‡æ–™è¡¨ï¼ˆ`place_suggestions`ï¼‰
- [x] å»ºè­°æŠ•ç¥¨è³‡æ–™è¡¨ï¼ˆ`suggestion_votes`ï¼‰
- [x] æ’é™¤æŠ•ç¥¨è³‡æ–™è¡¨ï¼ˆ`place_exclusion_votes`ï¼‰
- [x] æ¯æ—¥è²¢ç»çµ±è¨ˆè³‡æ–™è¡¨ï¼ˆ`user_daily_contributions`ï¼‰
- [x] Storage å±¤ï¼ˆ`contributionStorage.ts`ï¼‰
- [x] API: `POST /api/contribution/report-closed` å›å ±æ­‡æ¥­
- [x] API: `GET /api/contribution/my-reports` æˆ‘çš„å›å ±è¨˜éŒ„
- [x] API: `POST /api/contribution/suggest-place` å»ºè­°æ™¯é»
- [x] API: `GET /api/contribution/my-suggestions` æˆ‘çš„å»ºè­°è¨˜éŒ„
- [x] API: `POST /api/collection/:placeId/blacklist` åŠ å…¥é»‘åå–®
- [x] API: `DELETE /api/collection/:placeId/blacklist` ç§»é™¤é»‘åå–®
- [x] API: `GET /api/collection/blacklist` æˆ‘çš„é»‘åå–®
- [x] API: `GET /api/contribution/pending-votes` å¾…æŠ•ç¥¨æ™¯é»åˆ—è¡¨
- [x] API: `POST /api/contribution/vote/:placeId` æ’é™¤æŠ•ç¥¨
- [x] API: `GET /api/contribution/pending-suggestions` å¾…æŠ•ç¥¨å»ºè­°åˆ—è¡¨
- [x] API: `POST /api/contribution/vote-suggestion/:id` å»ºè­°æŠ•ç¥¨
- [x] API: `GET /api/contribution/stats` æˆ‘çš„è²¢ç»çµ±è¨ˆ
- [x] æ¯æ—¥ä¸Šé™æª¢æŸ¥
- [x] ç¶“é©—çå‹µç™¼æ”¾ï¼ˆèˆ‡ economyStorage æ•´åˆï¼‰

### å¾…é–‹ç™¼
- [ ] AI é å¯©æ•´åˆï¼ˆGemini å¯©æ ¸ï¼‰
- [ ] æ¯æœˆçµ±è¨ˆé‡ç½®ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
- [ ] æŠ½å¡æ¬Šé‡èª¿æ•´ï¼ˆåœ¨æ‰­è›‹æ¨¡çµ„æ•´åˆï¼‰
- [ ] Admin API: å›å ±å¯©æ ¸
- [ ] Admin API: å»ºè­°å¯©æ ¸
- [ ] Admin API: æ¢å¾©è»Ÿåˆªé™¤æ™¯é»
