好的，我们需要更新资料库 Schema 以支援新的核心功能。

请打开 `shared/schema.ts` 这个档案，并使用以下程式码，**完整地取代**档案中现有的全部内容。

这个新版本会：
1. 在 `users` 表中新增个人资料栏位。
2. 创建全新的 `announcements`, `events`, `coupons`, `user_coupons`, `user_collection` 表。
shared/schema.ts 的完整程式码
code
TypeScript
import {
  pgTable,
  serial,
  text,
  varchar,
  timestamp,
  boolean,
  integer,
  jsonb,
  pgEnum,
} from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

// --- Enums (枚举) ---
// 用于定义固定的选项集合，增加程式码可读性和资料一致性

export const userRoleEnum = pgEnum('user_role', ['traveler', 'merchant', 'specialist', 'admin']);
export const eventTypeEnum = pgEnum('event_type', ['flash', 'holiday']);
export const couponRankEnum = pgEnum('coupon_rank', ['R', 'S', 'SR', 'SSR', 'SP']);
export const userCouponStatusEnum = pgEnum('user_coupon_status', ['active', 'used', 'expired']);

// --- Tables (资料表) ---

/**
 * USERS TABLE
 * 储存所有使用者资讯，扩充了个人资料栏位
 */
export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  email: varchar('email', { length: 256 }).unique().notNull(),
  name: varchar('name', { length: 256 }),
  role: userRoleEnum('role').default('traveler').notNull(),
  activeRole: userRoleEnum('active_role').default('traveler').notNull(),
  isSuperAdmin: boolean('is_super_admin').default(false),
  createdAt: timestamp('created_at').defaultNow(),
  // 新增的个人资料栏位
  gender: varchar('gender', { length: 50 }),
  dateOfBirth: timestamp('date_of_birth'),
  phone: varchar('phone', { length: 50 }),
  dietaryRestrictions: jsonb('dietary_restrictions').default([]), // e.g., ['素食', '海鲜过敏']
  medicalHistory: jsonb('medical_history').default([]), // e.g., ['高血压']
  emergencyContact: jsonb('emergency_contact'), // e.g., { name: 'John Doe', phone: '12345' }
});

/**
 * ANNOUNCEMENTS TABLE
 * 储存由管理端发布的公告
 */
export const announcements = pgTable('announcements', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  isActive: boolean('is_active').default(true),
  createdAt: timestamp('created_at').defaultNow(),
});

/**
 * EVENTS TABLE
 * 储存快闪活动和节日限定活动
 */
export const events = pgTable('events', {
  id: serial('id').primaryKey(),
  title: varchar('title', { length: 256 }).notNull(),
  content: text('content'),
  eventType: eventTypeEnum('event_type').notNull(),
  startDate: timestamp('start_date').notNull(),
  endDate: timestamp('end_date').notNull(),
  imageUrl: varchar('image_url', { length: 512 }),
  createdAt: timestamp('created_at').defaultNow(),
});

/**
 * PLACES TABLE (假设已存在)
 * 行程卡/景点的基本资讯
 * (如果你的 place 表名称不同，请修改 'places')
 */
export const places = pgTable('places', {
    id: serial('id').primaryKey(),
    name: varchar('name', { length: 256 }).notNull(),
    // ... 你现有的其他 place 栏位 ...
    merchantId: integer('merchant_id').references(() => merchants.id), // 关联到商家
});

/**
 * MERCHANTS TABLE (假设已存在)
 * 商家基本资料
 * (如果你的 merchant 表名称不同，请修改 'merchants')
 */
export const merchants = pgTable('merchants', {
    id: serial('id').primaryKey(),
    userId: integer('user_id').references(() => users.id).unique(),
    // ... 你现有的其他 merchant 栏位 ...
});

/**
 * COUPONS TABLE
 * 储存由商家设定的优惠券“模板”
 */
export const coupons = pgTable('coupons', {
  id: serial('id').primaryKey(),
  placeId: integer('place_id').references(() => places.id).notNull(),
  merchantId: integer('merchant_id').references(() => merchants.id).notNull(),
  rank: couponRankEnum('rank').notNull(),
  title: varchar('title', { length: 256 }).notNull(),
  description: text('description'),
  terms: text('terms'), // 使用条款
  expiryDate: timestamp('expiry_date').notNull(),
  quantity: integer('quantity').default(-1), // -1 代表无限
  isActive: boolean('is_active').default(true),
});

/**
 * USER_COUPONS TABLE
 * 用户的“道具箱”，储存用户实际获得的每一张优惠券实例
 */
export const userCoupons = pgTable('user_coupons', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').references(() => users.id).notNull(),
  couponId: integer('coupon_id').references(() => coupons.id).notNull(), // 这是优惠券模板ID
  acquiredAt: timestamp('acquired_at').defaultNow(),
  status: userCouponStatusEnum('status').default('active').notNull(),
});

/**
 * USER_COLLECTION TABLE
 * 用户的“图鉴”，储存用户点亮过的所有行程卡
 */
export const userCollection = pgTable('user_collection', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').references(() => users.id).notNull(),
  placeId: integer('place_id').references(() => places.id).notNull(),
  firstAcquiredAt: timestamp('first_acquired_at').defaultNow(),
  isNew: boolean('is_new').default(true), // 用于显示红点提示
});

// --- Relations (资料表关联) ---
// 定义表之间的关系，方便 ORM 进行 JOIN 查询

export const usersRelations = relations(users, ({ one, many }) => ({
  merchantProfile: one(merchants, { fields: [users.id], references: [merchants.userId] }),
  coupons: many(userCoupons),
  collection: many(userCollection),
}));

export const placesRelations = relations(places, ({ one, many }) => ({
  merchant: one(merchants, { fields: [places.merchantId], references: [merchants.id] }),
  coupons: many(coupons),
}));

export const merchantsRelations = relations(merchants, ({ one, many }) => ({
    user: one(users, { fields: [merchants.userId], references: [users.id] }),
    places: many(places),
    coupons: many(coupons),
}));

export const couponsRelations = relations(coupons, ({ one }) => ({
  place: one(places, { fields: [coupons.placeId], references: [places.id] }),
  merchant: one(merchants, { fields: [coupons.merchantId], references: [merchants.id] }),
}));

export const userCouponsRelations = relations(userCoupons, ({ one }) => ({
  user: one(users, { fields: [userCoupons.userId], references: [users.id] }),
  couponTemplate: one(coupons, { fields: [userCoupons.couponId], references: [coupons.id] }),
}));

export const userCollectionRelations = relations(userCollection, ({ one }) => ({
    user: one(users, { fields: [userCollection.userId], references: [users.id] }),
    place: one(places, { fields: [userCollection.placeId], references: [places.id] }),
}));