code
JSON
[
  {
    "file": "modules/trip-planner/client/components/ChatView.tsx",
    "content": "// modules/trip-planner/client/components/ChatView.tsx\n\nimport React, { useEffect, useState, useRef } from \"react\";\nimport { \n  Send, \n  Phone, \n  Image as ImageIcon, \n  Plus, \n  MoreVertical, \n  UserPlus, \n  Video,\n  ArrowLeft\n} from \"lucide-react\";\nimport { format, isSameDay, isToday, isYesterday } from \"date-fns\";\n\n// UI Components (Shadcn & Tailwind)\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  DropdownMenu, \n  DropdownMenuContent, \n  DropdownMenuItem, \n  DropdownMenuTrigger \n} from \"@/components/ui/dropdown-menu\";\nimport { cn } from \"@/lib/utils\";\n\n// --- Types ---\ninterface ChatMessage {\n  sid: string;\n  author: string;\n  body: string;\n  dateCreated: Date;\n  type?: 'text' | 'image' | 'system';\n  mediaUrl?: string;\n}\n\ninterface Participant {\n  identity: string;\n  status: 'online' | 'offline';\n  lastRead?: Date;\n}\n\n// --- Mibu Brand Colors ---\n// Primary Green: #06C755\n// Accent Gold: #C4A77D\n// Background: #F0F4F8\n\nexport default function ChatView() {\n  // --- STATE ---\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [inputText, setInputText] = useState(\"\");\n  const [isTwilioReady, setIsTwilioReady] = useState(false);\n  const [participants, setParticipants] = useState<Participant[]>([]);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  // Mock Identity (Replace with real Auth/Twilio identity)\n  const myIdentity = \"user_me\"; \n\n  // --- TWILIO LOGIC PLACEHOLDER ---\n  // Keep your existing Twilio connection logic here.\n  useEffect(() => {\n    console.log(\"Initializing Twilio Chat...\");\n    setIsTwilioReady(true);\n\n    // MOCK DATA for Visual Verification\n    const mockMessages: ChatMessage[] = [\n      {\n        sid: \"1\",\n        author: \"system\",\n        body: \"Welcome to the Osaka Trip Group!\",\n        dateCreated: new Date(Date.now() - 86400000 * 2), // 2 days ago\n        type: 'system'\n      },\n      {\n        sid: \"2\",\n        author: \"alice\",\n        body: \"Has everyone bought their flight tickets yet?\",\n        dateCreated: new Date(Date.now() - 86400000), // Yesterday\n        type: 'text'\n      },\n      {\n        sid: \"3\",\n        author: \"user_me\",\n        body: \"Yes! I'm arriving at KIX at 10 AM.\",\n        dateCreated: new Date(Date.now() - 3600000), // 1 hour ago\n        type: 'text'\n      },\n      {\n        sid: \"4\",\n        author: \"bob\",\n        body: \"Nice. I'll be there around noon. Let's meet at the hotel?\",\n        dateCreated: new Date(Date.now() - 1800000), // 30 mins ago\n        type: 'text'\n      }\n    ];\n    setMessages(mockMessages);\n\n    setParticipants([\n      { identity: \"alice\", status: \"online\" },\n      { identity: \"bob\", status: \"offline\" },\n      { identity: \"user_me\", status: \"online\" }\n    ]);\n\n    // Cleanup logic\n    return () => {\n      console.log(\"Disconnecting Twilio...\");\n    };\n  }, []);\n\n  // Scroll to bottom on new message\n  useEffect(() => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [messages]);\n\n  // --- HANDLERS ---\n\n  const handleSendMessage = async () => {\n    if (!inputText.trim()) return;\n\n    // TODO: Connect this to Twilio channel.sendMessage(inputText)\n    const tempMsg: ChatMessage = {\n      sid: Date.now().toString(),\n      author: myIdentity,\n      body: inputText,\n      dateCreated: new Date(),\n      type: 'text'\n    };\n\n    setMessages(prev => [...prev, tempMsg]);\n    setInputText(\"\");\n  };\n\n  const handleImageUpload = () => {\n    // TODO: Implement file picker and Twilio media message logic\n    console.log(\"Trigger Image Upload\");\n    alert(\"Image Upload Logic to be implemented here (Keep existing logic)\");\n  };\n\n  const handleCall = (video: boolean = false) => {\n    // TODO: Connect to Twilio Voice/Video\n    console.log(`Starting ${video ? 'Video' : 'Voice'} Call...`);\n  };\n\n  const handleInvite = () => {\n    console.log(\"Open Invite Modal\");\n  };\n\n  // --- RENDER HELPERS ---\n\n  const formatMessageDate = (date: Date) => {\n    if (isToday(date)) return \"Today\";\n    if (isYesterday(date)) return \"Yesterday\";\n    return format(date, \"MMMM d, yyyy\");\n  };\n\n  const renderDateSeparator = (currentMsg: ChatMessage, prevMsg: ChatMessage | null) => {\n    if (!prevMsg || !isSameDay(currentMsg.dateCreated, prevMsg.dateCreated)) {\n      return (\n        <div className=\"flex justify-center my-4\">\n          <span className=\"bg-gray-200/60 text-gray-500 text-[10px] font-medium px-3 py-1 rounded-full\">\n            {formatMessageDate(currentMsg.dateCreated)}\n          </span>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"flex flex-col h-full bg-[#F0F4F8] relative overflow-hidden font-sans\">\n      \n      {/* --- HEADER --- */}\n      <header className=\"bg-white px-4 py-3 border-b border-gray-200 flex items-center justify-between shadow-sm z-20\">\n        <div className=\"flex items-center gap-3\">\n          <Button variant=\"ghost\" size=\"icon\" className=\"md:hidden -ml-2 text-gray-500\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          \n          {/* Group Avatar / Icon */}\n          <div className=\"relative\">\n            <Avatar className=\"h-10 w-10 border-2 border-white shadow-sm\">\n              <AvatarImage src=\"/placeholder-group.jpg\" />\n              <AvatarFallback className=\"bg-[#06C755] text-white\">TR</AvatarFallback>\n            </Avatar>\n            {/* Online Indicator */}\n            <span className=\"absolute bottom-0 right-0 h-3 w-3 rounded-full bg-[#06C755] border-2 border-white\"></span>\n          </div>\n\n          <div className=\"flex flex-col\">\n            <h2 className=\"text-sm font-bold text-gray-800 leading-tight\">Osaka Trip Group</h2>\n            <span className=\"text-xs text-gray-500 font-medium\">\n              {participants.length} participants\n            </span>\n          </div>\n        </div>\n\n        {/* Header Actions */}\n        <div className=\"flex items-center gap-1\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => handleCall(false)} \n            className=\"text-gray-400 hover:text-[#06C755] hover:bg-green-50 hidden sm:flex\"\n          >\n            <Phone className=\"h-5 w-5\" />\n          </Button>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={handleInvite} \n            className=\"text-gray-400 hover:text-[#06C755] hover:bg-green-50\"\n          >\n            <UserPlus className=\"h-5 w-5\" />\n          </Button>\n          \n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"icon\" className=\"text-gray-400 hover:text-gray-600\">\n                <MoreVertical className=\"h-5 w-5\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem onClick={() => handleCall(true)}>\n                <Video className=\"mr-2 h-4 w-4\" /> Video Call\n              </DropdownMenuItem>\n              <DropdownMenuItem className=\"text-red-500\">\n                Leave Group\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </header>\n\n      {/* --- MESSAGE LIST --- */}\n      <ScrollArea className=\"flex-1 px-4 py-4\">\n        <div className=\"max-w-3xl mx-auto flex flex-col justify-end min-h-full pb-2\">\n          {messages.map((msg, index) => {\n            const isMe = msg.author === myIdentity;\n            const prevMsg = index > 0 ? messages[index - 1] : null;\n            const showAvatar = !isMe && (!prevMsg || prevMsg.author !== msg.author);\n            \n            // System Message Handling\n            if (msg.type === 'system') {\n              return (\n                <div key={msg.sid} className=\"flex justify-center my-4\">\n                  <span className=\"text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full\">\n                    {msg.body}\n                  </span>\n                </div>\n              );\n            }\n\n            return (\n              <React.Fragment key={msg.sid}>\n                {renderDateSeparator(msg, prevMsg)}\n                \n                <div className={cn(\n                  \"flex w-full gap-2 mb-1\", \n                  isMe ? \"justify-end\" : \"justify-start\"\n                )}>\n                  \n                  {/* Avatar (Left) */}\n                  {!isMe && (\n                    <div className=\"flex-shrink-0 w-8 flex flex-col justify-end\">\n                      {showAvatar ? (\n                        <Avatar className=\"h-8 w-8 mb-1\">\n                          <AvatarFallback className=\"bg-[#C4A77D] text-white text-[10px]\">\n                            {msg.author.slice(0, 2).toUpperCase()}\n                          </AvatarFallback>\n                        </Avatar>\n                      ) : <div className=\"w-8\" />}\n                    </div>\n                  )}\n\n                  {/* Bubble */}\n                  <div className={cn(\n                    \"relative max-w-[70%] px-4 py-2 shadow-sm text-sm\",\n                    isMe \n                      ? \"bg-[#06C755] text-white rounded-2xl rounded-tr-none\"\n                      : \"bg-white text-gray-800 rounded-2xl rounded-tl-none\"\n                  )}>\n                    <p className=\"whitespace-pre-wrap leading-relaxed\">\n                      {msg.body}\n                    </p>\n                    \n                    {/* Timestamp */}\n                    <div className={cn(\n                      \"text-[9px] mt-1 text-right\",\n                      isMe ? \"text-green-100\" : \"text-gray-400\"\n                    )}>\n                      {format(msg.dateCreated, \"h:mm a\")}\n                    </div>\n                  </div>\n\n                </div>\n              </React.Fragment>\n            );\n          })}\n          <div ref={scrollRef} />\n        </div>\n      </ScrollArea>\n\n      {/* --- INPUT AREA --- */}\n      <div className=\"bg-white p-3 border-t border-gray-100\">\n        <div className=\"max-w-3xl mx-auto flex items-center gap-2\">\n          \n          {/* Attach Button */}\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={handleImageUpload}\n            className=\"text-gray-400 hover:text-[#06C755] hover:bg-green-50 rounded-full h-10 w-10 flex-shrink-0\"\n          >\n            <ImageIcon className=\"h-5 w-5\" />\n          </Button>\n\n          {/* Main Input */}\n          <div className=\"flex-1 relative\">\n            <Input\n              value={inputText}\n              onChange={(e) => setInputText(e.target.value)}\n              onKeyDown={(e) => e.key === \"Enter\" && handleSendMessage()}\n              placeholder=\"Type a message...\"\n              className=\"pr-10 rounded-full border-gray-200 bg-[#F0F4F8] focus-visible:ring-[#06C755] focus-visible:ring-offset-0 h-10\"\n            />\n            <Button \n              variant=\"ghost\" \n              size=\"icon\" \n              className=\"absolute right-1 top-1 h-8 w-8 text-gray-400 hover:text-[#06C755] rounded-full\"\n            >\n              <Plus className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {/* Send Button */}\n          <Button \n            onClick={handleSendMessage} \n            disabled={!inputText.trim()}\n            className={cn(\n              \"rounded-full h-10 w-10 p-0 transition-all flex-shrink-0\",\n              inputText.trim() \n                ? \"bg-[#06C755] hover:bg-[#05a346] text-white shadow-md shadow-green-200\" \n                : \"bg-gray-100 text-gray-300\"\n            )}\n          >\n            <Send className=\"h-4 w-4 ml-0.5\" />\n          </Button>\n\n        </div>\n      </div>\n    </div>\n  );\n}\n"
  }
]