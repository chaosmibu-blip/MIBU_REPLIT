/ --- 开始复制以下程式码 ---

import { pgEnum, jsonb, timestamp, varchar } from 'drizzle-orm/pg-core'; // 确保这些类型被引入
import { relations } from 'drizzle-orm'; // 确保 relations 被引入

// --- 在档案顶部或合适的位置，新增这些 Enum ---
export const eventTypeEnum = pgEnum('event_type', ['flash', 'holiday']);
export const userCouponStatusEnum = pgEnum('user_coupon_status', ['active', 'used', 'expired']);
// 注意: couponRankEnum 可能已存在，如果存在则不需重复添加

// --- 在现有的 users 表定义中，找到栏位列表，在里面新增以下栏位 ---
/*
  请在 users 表中添加：
  gender: varchar('gender', { length: 50 }),
  dateOfBirth: timestamp('date_of_birth'),
  phone: varchar('phone', { length: 50 }),
  dietaryRestrictions: jsonb('dietary_restrictions').default([]),
  medicalHistory: jsonb('medical_history').default([]),
  emergencyContact: jsonb('emergency_contact'),
*/


// --- 在整个档案的末尾，新增以下新的资料表定义 ---

/**
 * ANNOUNCEMENTS TABLE
 * 储存由管理端发布的公告
 */
export const announcements = pgTable('announcements', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  isActive: boolean('is_active').default(true),
  createdAt: timestamp('created_at').defaultNow(),
});

/**
 * EVENTS TABLE
 * 储存快闪活动和节日限定活动
 */
export const events = pgTable('events', {
  id: serial('id').primaryKey(),
  title: varchar('title', { length: 256 }).notNull(),
  content: text('content'),
  eventType: eventTypeEnum('event_type').notNull(),
  startDate: timestamp('start_date').notNull(),
  endDate: timestamp('end_date').notNull(),
  imageUrl: varchar('image_url', { length: 512 }),
  createdAt: timestamp('created_at').defaultNow(),
});

/**
 * USER_COUPONS TABLE
 * 用户的“道具箱”，储存用户实际获得的每一张优惠券实例
 * (假设 coupons 表已存在)
 */
export const userCoupons = pgTable('user_coupons', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').references(() => users.id).notNull(),
  couponId: integer('coupon_id').references(() => coupons.id).notNull(), // 假设 coupons 表已存在
  acquiredAt: timestamp('acquired_at').defaultNow(),
  status: userCouponStatusEnum('status').default('active').notNull(),
});

/**
 * USER_COLLECTION TABLE
 * 用户的“图鉴”，储存用户点亮过的所有行程卡
 * (假设 places 表已存在)
 */
export const userCollection = pgTable('user_collection', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').references(() => users.id).notNull(),
  placeId: integer('place_id').references(() => places.id).notNull(), // 假设 places 表已存在
  firstAcquiredAt: timestamp('first_acquired_at').defaultNow(),
  isNew: boolean('is_new').default(true), // 用于显示红点提示
});


// --- 在档案末尾，同样新增这些新的资料表关联关系 ---

export const userCouponsRelations = relations(userCoupons, ({ one }) => ({
  user: one(users, { fields: [userCoupons.userId], references: [users.id] }),
  couponTemplate: one(coupons, { fields: [userCoupons.couponId], references: [coupons.id] }), // 假设 coupons 表已存在
}));

export const userCollectionRelations = relations(userCollection, ({ one }) => ({
    user: one(users, { fields: [userCollection.userId], references: [users.id] }),
    place: one(places, { fields: [userCollection.placeId], references: [places.id] }), // 假设 places 表已存在
}));

// --- 最后，在现有的 usersRelations 中，新增以下两行 ---
/*
  请在现有的 usersRelations 定义中，添加：
  coupons: many(userCoupons),
  collection: many(userCollection),
*/```

---
