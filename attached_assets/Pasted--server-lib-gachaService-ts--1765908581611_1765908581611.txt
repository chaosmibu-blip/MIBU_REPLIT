好的，我们开始重构扭蛋功能。

第一步，请在 `server/lib/` 资料夹下，创建一个名为 `gachaService.ts` 的新档案，并将以下完整程式码贴入其中。这个服务将作为我们扭蛋系统的“大脑”。
server/lib/gachaService.ts 的完整程式码
code
TypeScript
import * as storage from '../storage';
import { Place, Coupon } from '../../shared/schema'; // 假设你的型别在 schema.ts

// 定义回传给前端的资料结构
export interface GachaResult {
  place: Place;
  drawnCoupon: Coupon | null;
  merchantInfo: string | null; // 预留给商家优惠讯息的栏位
}

// 优惠券机率设定 (未来可以从资料库读取)
const COUPON_PROBABILITIES = {
  SP: 0.02,  // 2%
  SSR: 0.08, // 8%
  SR: 0.15,  // 15%
  S: 0.23,   // 23%
  R: 0.32,   // 32%
};

/**
 * 执行一次抽奖计算，决定是否能获得优惠券
 * @param {Coupon[]} availableCoupons - 该地点可用的所有优惠券
 * @returns {Coupon | null} - 抽中的优惠券，或 null
 */
const drawCoupon = (availableCoupons: Coupon[]): Coupon | null => {
  if (!availableCoupons || availableCoupons.length === 0) {
    return null;
  }

  const rand = Math.random();
  let cumulativeProbability = 0;

  // 按照 SP -> SSR -> SR -> S -> R 的顺序检查
  for (const rank of ['SP', 'SSR', 'SR', 'S', 'R']) {
    cumulativeProbability += COUPON_PROBABILITIES[rank];
    if (rand < cumulativeProbability) {
      // 触发了这个等级的抽奖，现在从可用的券中找一张对应等级的
      const winningCoupon = availableCoupons.find(c => c.rank === rank);
      if (winningCoupon) {
        console.log(`[GachaService] Coupon draw success! Rank: ${rank}`);
        return winningCoupon;
      }
    }
  }

  return null; // 没有中任何等级的奖
};


/**
 * 执行扭蛋流程的主函式
 * @param {number} userId - 执行操作的使用者ID
 * @param {string} cityId - 选择的城市ID (假设)
 * @param {number} count - 抽取的数量
 * @returns {Promise<GachaResult[]>} - 扭蛋结果阵列
 */
export const performGachaDraw = async (userId: number, cityId: string, count: number): Promise<GachaResult[]> => {
  console.log(`[GachaService] Starting gacha draw for user ${userId} in city ${cityId} for ${count} items.`);
  
  // 1. 从资料库随机获取指定数量的行程卡 (Places)
  const randomPlaces = await storage.getRandomPlacesByCity(cityId, count);
  
  const results: GachaResult[] = [];

  // 2. 遍历每一张抽到的行程卡，处理后续逻辑
  for (const place of randomPlaces) {
    let drawnCoupon: Coupon | null = null;
    
    // 3. 将行程卡加入用户图鉴 (如果不存在)
    await storage.upsertUserCollectionEntry(userId, place.id);
    
    // 4. 检查这张卡片是否有关联的商家
    if (place.merchantId) {
      // 5. 获取该商家为此地点设定的所有有效优惠券
      const availableCoupons = await storage.getActiveCouponsForPlace(place.id);
      
      // 6. 如果有可用的优惠券，则进行抽奖
      if (availableCoupons.length > 0) {
        drawnCoupon = drawCoupon(availableCoupons);
        
        // 7. 如果抽中了，将优惠券加入用户的道具箱
        if (drawnCoupon) {
          await storage.addUserCoupon(userId, drawnCoupon.id);
        }
      }
    }
    
    // 8. 组合最终结果
    results.push({
      place: place,
      drawnCoupon: drawnCoupon,
      merchantInfo: null, // TODO: 未来从商家资料中获取优惠讯息
    });
  }
  
  console.log(`[GachaService] Gacha draw finished. Returning ${results.length} results.`);
  return results;
};